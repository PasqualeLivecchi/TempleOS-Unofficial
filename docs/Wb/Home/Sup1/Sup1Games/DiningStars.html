<!DOCTYPE HTML>
<html style="background-color:#FFFFFF;">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=US-ASCII">
<title>The Temple Operating System</title>
<meta name="keywords" content="Operating System,64-Bit,64 Bit,Temple,OS,TempleOS,Free,Open Source,Public Domain,x86_64">
<meta name="generator" content="TempleOS (U) V5.04">
<style type="text/css">
.cB0{color:#000000;background-color:#55ffff;}
.cB1{color:#0000aa;background-color:#55ffff;}
.cB2{color:#00aa00;background-color:#55ffff;}
.cB3{color:#00aaaa;background-color:#55ffff;}
.cB4{color:#aa0000;background-color:#55ffff;}
.cB5{color:#aa00aa;background-color:#55ffff;}
.cB6{color:#aa5500;background-color:#55ffff;}
.cB7{color:#aaaaaa;background-color:#55ffff;}
.cB9{color:#5555ff;background-color:#55ffff;}
.cBA{color:#55ff55;background-color:#55ffff;}
.cBB{color:#55ffff;background-color:#55ffff;}
.cF0{color:#000000;background-color:#ffffff;}
.cF1{color:#0000aa;background-color:#ffffff;}
.cF2{color:#00aa00;background-color:#ffffff;}
.cF3{color:#00aaaa;background-color:#ffffff;}
.cF4{color:#aa0000;background-color:#ffffff;}
.cF5{color:#aa00aa;background-color:#ffffff;}
.cF6{color:#aa5500;background-color:#ffffff;}
.cF7{color:#aaaaaa;background-color:#ffffff;}
.cF8{color:#555555;background-color:#ffffff;}
.cF9{color:#5555ff;background-color:#ffffff;}
.cFA{color:#55ff55;background-color:#ffffff;}
.cFB{color:#55ffff;background-color:#ffffff;}
.cFC{color:#ff5555;background-color:#ffffff;}
.cFD{color:#ff55ff;background-color:#ffffff;}
.cFE{color:#ffff55;background-color:#ffffff;}
.cFF{color:#ffffff;background-color:#ffffff;}
</style>
</head>
<body style="background-color:#55FFFF; border-style:solid;
	  border-width:8px; border-color:#0000AA;
	  margin-left:auto; margin-right:auto; width:800px; ">
<pre style="font-family:courier;font-size:10pt">
<div style="margin-left:auto; margin-right:auto; width: 640px;">
<a name="l1"></a><span class=cB2>//This uses </span><a href="https://tosrevive.github.io/TempleOS-Unofficial/Wb/Demo/Lectures/FixedPoint.html#l1"><span class=cB4>fixed-point</span></a><span class=cB2>.</span><span class=cB0>
<a name="l2"></a>
<a name="l3"></a>
<a name="l4"></a></span><span class=cB5>RegDft</span><span class=cB0>(</span><span class=cB6>&quot;TempleOS/DiningStars&quot;</span><span class=cB0>,</span><span class=cB6>&quot;F64 best_score=9999;\n&quot;</span><span class=cB0>);
<a name="l5"></a></span><span class=cB5>RegExe</span><span class=cB0>(</span><span class=cB6>&quot;TempleOS/DiningStars&quot;</span><span class=cB0>);
<a name="l6"></a>
<a name="l7"></a>#</span><span class=cB1>define</span><span class=cB0> PERSON_SCALE    6.0
<a name="l8"></a>
<a name="l9"></a>
<a name="l10"></a>
<a name="l11"></a>
<a name="l12"></a>
<a name="l13"></a>
<a name="l14"></a>
<a name="l15"></a>
<a name="l16"></a>
<a name="l17"></a>
<a name="l18"></a>                </span><span class=cBA>&lt;1&gt;/* Graphics Not Rendered in HTML */</span><span class=cB0>
<a name="l19"></a>
<a name="l20"></a>
<a name="l21"></a>
<a name="l22"></a>
<a name="l23"></a>
<a name="l24"></a>
<a name="l25"></a>
<a name="l26"></a>
<a name="l27"></a>
<a name="l28"></a>                </span><span class=cBA>&lt;2&gt;/* Graphics Not Rendered in HTML */</span><span class=cB0>
<a name="l29"></a>
<a name="l30"></a>
<a name="l31"></a>
<a name="l32"></a>
<a name="l33"></a>
<a name="l34"></a>
<a name="l35"></a>
<a name="l36"></a>
<a name="l37"></a>                </span><span class=cBA>&lt;3&gt;/* Graphics Not Rendered in HTML */</span><span class=cB0>
<a name="l38"></a>
<a name="l39"></a>
<a name="l40"></a>
<a name="l41"></a>
<a name="l42"></a>
<a name="l43"></a>
<a name="l44"></a>#</span><span class=cB1>define</span><span class=cB0> PLANT_SCALE     6.0
<a name="l45"></a>
<a name="l46"></a>
<a name="l47"></a>
<a name="l48"></a>                     </span><span class=cBA>&lt;4&gt;/* Graphics Not Rendered in HTML */</span><span class=cB0>
<a name="l49"></a>
<a name="l50"></a>
<a name="l51"></a>
<a name="l52"></a>
<a name="l53"></a>
<a name="l54"></a>
<a name="l55"></a>
<a name="l56"></a>
<a name="l57"></a>
<a name="l58"></a>
<a name="l59"></a>
<a name="l60"></a>
<a name="l61"></a>
<a name="l62"></a>
<a name="l63"></a>                      </span><span class=cBA>&lt;5&gt;/* Graphics Not Rendered in HTML */</span><span class=cB0>
<a name="l64"></a>
<a name="l65"></a>
<a name="l66"></a>
<a name="l67"></a>
<a name="l68"></a>
<a name="l69"></a>
<a name="l70"></a>
<a name="l71"></a></span><span class=cB1>class</span><span class=cB0> Wall
<a name="l72"></a>{
<a name="l73"></a>  Wall *next,*last;
<a name="l74"></a>  </span><span class=cB9>CD3I32</span><span class=cB0> p1,p2;
<a name="l75"></a>  </span><span class=cB9>I64</span><span class=cB0> cpu_num;
<a name="l76"></a>} walls_head;
<a name="l77"></a>
<a name="l78"></a>
<a name="l79"></a>
<a name="l80"></a>
<a name="l81"></a>#</span><span class=cB1>define</span><span class=cB0> SCRN_SCALE              1024
<a name="l82"></a>#</span><span class=cB1>define</span><span class=cB0> PLOT_GRID_WIDTH         24
<a name="l83"></a>#</span><span class=cB1>define</span><span class=cB0> PLOT_GRID_HEIGHT        24
<a name="l84"></a>#</span><span class=cB1>define</span><span class=cB0> MAN_HEIGHT              300
<a name="l85"></a>#</span><span class=cB1>define</span><span class=cB0> WALL_HEIGHT             1.0
<a name="l86"></a>#</span><span class=cB1>define</span><span class=cB0> BLUEPRINT_SCALE         4
<a name="l87"></a>
<a name="l88"></a></span><span class=cB9>CDC</span><span class=cB0> *blueprint_dc;
<a name="l89"></a></span><span class=cB9>I64</span><span class=cB0> blueprint_width,blueprint_height;
<a name="l90"></a></span><span class=cB1>U8</span><span class=cB0> *blueprint=</span><span class=cB3>NULL</span><span class=cB0>,
<a name="l91"></a>   *panels_processed=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l92"></a>
<a name="l93"></a></span><span class=cB9>I64</span><span class=cB0> man_xx,man_yy;
<a name="l94"></a></span><span class=cB1>F64</span><span class=cB0> man_theta;
<a name="l95"></a>
<a name="l96"></a></span><span class=cB1>F64</span><span class=cB0> t0,tf;
<a name="l97"></a>
<a name="l98"></a>#</span><span class=cB1>define</span><span class=cB0> PERSONS_NUM     16
<a name="l99"></a></span><span class=cB1>class</span><span class=cB0> Person
<a name="l100"></a>{
<a name="l101"></a>  </span><span class=cB9>I64</span><span class=cB0> x,y;
<a name="l102"></a>} persons[PERSONS_NUM];
<a name="l103"></a>
<a name="l104"></a></span><span class=cB1>U0</span><span class=cB0> DSTransform(</span><span class=cB9>CDC</span><span class=cB0> *dc,</span><span class=cB9>I64</span><span class=cB0> *x,</span><span class=cB9>I64</span><span class=cB0> *y,</span><span class=cB9>I64</span><span class=cB0> *z)
<a name="l105"></a>{
<a name="l106"></a>  </span><span class=cB9>I64</span><span class=cB0> zz;
<a name="l107"></a>  </span><span class=cB5>Mat4x4MulXYZ</span><span class=cB0>(dc-&gt;r,x,y,z);
<a name="l108"></a>  zz=SCRN_SCALE/3+*z;
<a name="l109"></a>  </span><span class=cB1>if</span><span class=cB0> (zz&lt;1) zz=1;
<a name="l110"></a>  *x=SCRN_SCALE/2* *x/zz;
<a name="l111"></a>  *y=SCRN_SCALE/2* (*y+MAN_HEIGHT)/zz;
<a name="l112"></a>  *x+=dc-&gt;x;
<a name="l113"></a>  *y+=dc-&gt;y;
<a name="l114"></a>  *z+=dc-&gt;z;
<a name="l115"></a>}
<a name="l116"></a>
<a name="l117"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> DSLighting(</span><span class=cB9>CDC</span><span class=cB0> *dc,</span><span class=cB9>CD3I32</span><span class=cB0> *p1,</span><span class=cB9>CD3I32</span><span class=cB0> *p2,</span><span class=cB9>CD3I32</span><span class=cB0> *p3,
<a name="l118"></a>        </span><span class=cB9>CColorROPU32</span><span class=cB0> color)
<a name="l119"></a>{
<a name="l120"></a>  </span><span class=cB9>CD3I32</span><span class=cB0> v1,v2;
<a name="l121"></a>  </span><span class=cB9>I64</span><span class=cB0> i,vn_x,vn_y,vn_z;
<a name="l122"></a>  </span><span class=cB1>F64</span><span class=cB0> d;
<a name="l123"></a>
<a name="l124"></a>  v1.x=p1-&gt;x-p2-&gt;x;
<a name="l125"></a>  v1.y=p1-&gt;y-p2-&gt;y;
<a name="l126"></a>  v1.z=p1-&gt;z-p2-&gt;z;
<a name="l127"></a>
<a name="l128"></a>  v2.x=p3-&gt;x-p2-&gt;x;
<a name="l129"></a>  v2.y=p3-&gt;y-p2-&gt;y;
<a name="l130"></a>  v2.z=p3-&gt;z-p2-&gt;z;
<a name="l131"></a>
<a name="l132"></a>  </span><span class=cB2>//V1 and V2 are vects along two sides</span><span class=cB0>
<a name="l133"></a>  </span><span class=cB2>//of the tri joined at p2.</span><span class=cB0>
<a name="l134"></a>
<a name="l135"></a>  vn_x=v1.y*v2.z-v1.z*v2.y;
<a name="l136"></a>  vn_y=v1.z*v2.x-v1.x*v2.z;
<a name="l137"></a>  vn_z=v1.x*v2.y-v1.y*v2.x;
<a name="l138"></a>  </span><span class=cB1>if</span><span class=cB0> (d=</span><span class=cB5>Sqrt</span><span class=cB7>(</span><span class=cB5>SqrI64</span><span class=cB0>(vn_x)+</span><span class=cB5>SqrI64</span><span class=cB0>(vn_y)+</span><span class=cB5>SqrI64</span><span class=cB0>(vn_z)</span><span class=cB7>)</span><span class=cB0>)
<a name="l139"></a>    d=1&lt;&lt;16/d;
<a name="l140"></a>  vn_x*=d;
<a name="l141"></a>  vn_y*=d;
<a name="l142"></a>  vn_z*=d;
<a name="l143"></a></span><span class=cB2>//Vn is the cross product of V1 and V3</span><span class=cB0>
<a name="l144"></a>  </span><span class=cB2>//which means it is perpendicular.  It</span><span class=cB0>
<a name="l145"></a>  </span><span class=cB2>//is the normal vect to the surface.</span><span class=cB0>
<a name="l146"></a>  </span><span class=cB2>//It has been scaled to length 65536.</span><span class=cB0>
<a name="l147"></a>
<a name="l148"></a>  </span><span class=cB2>//Light source has been scaled to length 65536.</span><span class=cB0>
<a name="l149"></a>  i=(vn_x*dc-&gt;ls.x+vn_y*dc-&gt;ls.y+vn_z*dc-&gt;ls.z)&gt;&gt;16;
<a name="l150"></a>
<a name="l151"></a>  i=(0x8000+i)&gt;&gt;1;</span><span class=cB2>//Tables are too dark ****TODO****</span><span class=cB0>
<a name="l152"></a>
<a name="l153"></a>  </span><span class=cB2>//The dot product of the light source</span><span class=cB0>
<a name="l154"></a>  </span><span class=cB2>//vect and the surface normal</span><span class=cB0>
<a name="l155"></a>  </span><span class=cB2>//gives an illumination number.</span><span class=cB0>
<a name="l156"></a>  </span><span class=cB2>//65536*65536&gt;&gt;16=65536</span><span class=cB0>
<a name="l157"></a>
<a name="l158"></a>  </span><span class=cB2>//TempleOS will generate a random U16</span><span class=cB0>
<a name="l159"></a>  </span><span class=cB2>//and compare to dither_probability_u16 and</span><span class=cB0>
<a name="l160"></a>  </span><span class=cB2>//will pick from two colors.</span><span class=cB0>
<a name="l161"></a>  </span><span class=cB2>//Probability dithering does not work with thick&gt;1 at this time.</span><span class=cB0>
<a name="l162"></a>  </span><span class=cB1>if</span><span class=cB0> (color.c0.rop&amp;</span><span class=cB3>ROPBF_TWO_SIDED</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l163"></a>    color.c0.rop&amp;=~</span><span class=cB3>ROPBF_TWO_SIDED</span><span class=cB0>;
<a name="l164"></a>    i=</span><span class=cB5>AbsI64</span><span class=cB0>(i)&lt;&lt;1;
<a name="l165"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>else</span><span class=cB0>
<a name="l166"></a>    i+=65536;
<a name="l167"></a>  </span><span class=cB1>if</span><span class=cB0> (color.c0.rop&amp;</span><span class=cB3>ROPBF_HALF_RANGE_COLOR</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l168"></a>    color.c0.rop&amp;=~</span><span class=cB3>ROPBF_HALF_RANGE_COLOR</span><span class=cB0>;
<a name="l169"></a>    i&gt;&gt;=1;
<a name="l170"></a>    </span><span class=cB1>if</span><span class=cB0> (color&gt;=8) {
<a name="l171"></a>      color-=8;
<a name="l172"></a>      i+=65536;
<a name="l173"></a>    }
<a name="l174"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l175"></a>  </span><span class=cB1>if</span><span class=cB0> (i&lt;65536) </span><span class=cB7>{</span><span class=cB0>
<a name="l176"></a>    dc-&gt;color=</span><span class=cB3>ROPF_PROBABILITY_DITHER</span><span class=cB0>+color&lt;&lt;16+</span><span class=cB3>BLACK</span><span class=cB0>;
<a name="l177"></a>    dc-&gt;dither_probability_u16=i;
<a name="l178"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>else</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l179"></a>    dc-&gt;color=</span><span class=cB3>ROPF_PROBABILITY_DITHER</span><span class=cB0>+(color^8)&lt;&lt;16+color;
<a name="l180"></a>    dc-&gt;dither_probability_u16=i-65536;
<a name="l181"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l182"></a>}
<a name="l183"></a>
<a name="l184"></a>#</span><span class=cB1>define</span><span class=cB0> LOS_SCALE       4
<a name="l185"></a>
<a name="l186"></a></span><span class=cB1>Bool</span><span class=cB0> LOSPlot(</span><span class=cB1>U8</span><span class=cB0> *,</span><span class=cB9>I64</span><span class=cB0> x,</span><span class=cB9>I64</span><span class=cB0> y,</span><span class=cB9>I64</span><span class=cB0>)
<a name="l187"></a>{
<a name="l188"></a>  </span><span class=cB1>if</span><span class=cB0> (blueprint[</span><span class=cB7>(</span><span class=cB0>y/LOS_SCALE</span><span class=cB7>)</span><span class=cB0>*blueprint_width+</span><span class=cB7>(</span><span class=cB0>x/LOS_SCALE</span><span class=cB7>)</span><span class=cB0>]==</span><span class=cB3>WHITE</span><span class=cB0>)
<a name="l189"></a>    </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l190"></a>  </span><span class=cB1>else</span><span class=cB0>
<a name="l191"></a>    </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>TRUE</span><span class=cB0>;
<a name="l192"></a>}
<a name="l193"></a>
<a name="l194"></a></span><span class=cB1>Bool</span><span class=cB0> LOS(</span><span class=cB9>I64</span><span class=cB0> x1,</span><span class=cB9>I64</span><span class=cB0> y1,</span><span class=cB9>I64</span><span class=cB0> x2,</span><span class=cB9>I64</span><span class=cB0> y2)
<a name="l195"></a>{ </span><span class=cB2>//Line of sight</span><span class=cB0>
<a name="l196"></a>  </span><span class=cB1>return</span><span class=cB0> </span><span class=cB5>Line</span><span class=cB0>(</span><span class=cB3>NULL</span><span class=cB0>,x1*LOS_SCALE/SCRN_SCALE,y1*LOS_SCALE/SCRN_SCALE,0,
<a name="l197"></a>        x2*LOS_SCALE/SCRN_SCALE,y2*LOS_SCALE/SCRN_SCALE,0,&amp;LOSPlot);
<a name="l198"></a>}
<a name="l199"></a>
<a name="l200"></a></span><span class=cB9>I64</span><span class=cB0> mp_not_done_flags;
<a name="l201"></a></span><span class=cB9>I64</span><span class=cB0> *r1,*r2,*r3,*s2w,cx,cy,xh,yh,zh,x1h,y1h;
<a name="l202"></a>
<a name="l203"></a></span><span class=cB1>U0</span><span class=cB0> MPDrawWalls(</span><span class=cB9>CDC</span><span class=cB0> *_dc)
<a name="l204"></a>{
<a name="l205"></a>  </span><span class=cB9>CD3I32</span><span class=cB0> poly[4];
<a name="l206"></a>  </span><span class=cB9>I64</span><span class=cB0> i,j,n,cpu_num=</span><span class=cB5>Gs</span><span class=cB0>-&gt;num,xx,yy,x,y,x1,y1,z1,x2,y2,_x1h,_y1h,
<a name="l207"></a>        dx,dy,xx1,yy1,xx2,yy2,c,x1w,y1w,*_r3=</span><span class=cB5>Mat4x4New</span><span class=cB0>(r3);
<a name="l208"></a>  Wall *tmpw;
<a name="l209"></a>  </span><span class=cB9>CDC</span><span class=cB0> *dc=</span><span class=cB5>MAllocIdent</span><span class=cB0>(_dc);
<a name="l210"></a>  dc-&gt;r=</span><span class=cB5>Mat4x4New</span><span class=cB0>(_dc-&gt;r);
<a name="l211"></a>  _x1h=x1h-xh*cpu_num;
<a name="l212"></a>  _y1h=y1h-yh*cpu_num;
<a name="l213"></a>  </span><span class=cB1>for</span><span class=cB0> (j=cpu_num;j&lt;PLOT_GRID_HEIGHT*2;j+=</span><span class=cBB>mp_cnt</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l214"></a>    x1w=_x1h;
<a name="l215"></a>    y1w=_y1h;
<a name="l216"></a>    </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;PLOT_GRID_WIDTH*4;i++) {
<a name="l217"></a>      xx=x1w/SCRN_SCALE; yy=y1w/SCRN_SCALE;
<a name="l218"></a>      x=xx*SCRN_SCALE-man_xx; y=yy*SCRN_SCALE-man_yy;
<a name="l219"></a>      </span><span class=cB1>if</span><span class=cB0> (1&lt;=xx&lt;blueprint_width-1 &amp;&amp; 1&lt;=yy&lt;blueprint_height-1 &amp;&amp;
<a name="l220"></a>            !</span><span class=cB5>LBts</span><span class=cB7>(</span><span class=cB0>panels_processed,yy*blueprint_width+xx</span><span class=cB7>)</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l221"></a>        </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB7>(</span><span class=cB0>c=blueprint[yy*blueprint_width+xx]</span><span class=cB7>)</span><span class=cB0> &amp;&amp;
<a name="l222"></a>              LOS</span><span class=cB7>(</span><span class=cB0>xx*SCRN_SCALE+SCRN_SCALE/2,
<a name="l223"></a>              yy*SCRN_SCALE+SCRN_SCALE/2,
<a name="l224"></a>              man_xx,man_yy</span><span class=cB7>)</span><span class=cB0>) {
<a name="l225"></a>          </span><span class=cB1>if</span><span class=cB0> (c==</span><span class=cB3>WHITE</span><span class=cB0>||c==</span><span class=cB3>LTBLUE</span><span class=cB0>)
<a name="l226"></a>            dc-&gt;color=</span><span class=cB3>BROWN</span><span class=cB0>;
<a name="l227"></a>          </span><span class=cB1>else</span><span class=cB0>
<a name="l228"></a>            dc-&gt;color=c;
<a name="l229"></a>          poly[0].x=x;
<a name="l230"></a>          poly[0].y=y;
<a name="l231"></a>          poly[0].z=0;
<a name="l232"></a>          poly[1].x=x+SCRN_SCALE;
<a name="l233"></a>          poly[1].y=y;
<a name="l234"></a>          poly[1].z=0;
<a name="l235"></a>          poly[2].x=x+SCRN_SCALE;
<a name="l236"></a>          poly[2].y=y+SCRN_SCALE;
<a name="l237"></a>          poly[2].z=0;
<a name="l238"></a>          poly[3].x=x;
<a name="l239"></a>          poly[3].y=y+SCRN_SCALE;
<a name="l240"></a>          poly[3].z=0;
<a name="l241"></a>          </span><span class=cB5>GrFillPoly3</span><span class=cB0>(dc,4,poly);
<a name="l242"></a>          </span><span class=cB1>if</span><span class=cB0> (!</span><span class=cB7>(</span><span class=cB0>(yy*blueprint_width+xx)%3</span><span class=cB7>)</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l243"></a>            </span><span class=cB1>if</span><span class=cB0> (c==</span><span class=cB3>GREEN</span><span class=cB0>) {
<a name="l244"></a>              x1=x+SCRN_SCALE/2;
<a name="l245"></a>              y1=y+SCRN_SCALE/2;
<a name="l246"></a>              z1=0;
<a name="l247"></a>              </span><span class=cB5>DCTransform</span><span class=cB0>(dc,&amp;x1,&amp;y1,&amp;z1);
<a name="l248"></a>              </span><span class=cB1>if</span><span class=cB0> (z1&gt;0)
<a name="l249"></a>                </span><span class=cB5>Sprite3Mat4x4B</span><span class=cB0>(dc,x+SCRN_SCALE/2,y+SCRN_SCALE/2,0,</span><span class=cBA>&lt;4&gt;</span><span class=cB0>,_r3);
<a name="l250"></a>            } </span><span class=cB1>else</span><span class=cB0> </span><span class=cB1>if</span><span class=cB0> (c==</span><span class=cB3>BROWN</span><span class=cB0>) {
<a name="l251"></a>              x1=x+SCRN_SCALE/2;
<a name="l252"></a>              y1=y+SCRN_SCALE/2;
<a name="l253"></a>              z1=0;
<a name="l254"></a>              </span><span class=cB5>DCTransform</span><span class=cB0>(dc,&amp;x1,&amp;y1,&amp;z1);
<a name="l255"></a>              </span><span class=cB1>if</span><span class=cB0> (z1&gt;0)
<a name="l256"></a>                </span><span class=cB5>Sprite3Mat4x4B</span><span class=cB0>(dc,x+SCRN_SCALE/2,y+SCRN_SCALE/2,0,</span><span class=cBA>&lt;5&gt;</span><span class=cB0>,_r3);
<a name="l257"></a>            }
<a name="l258"></a>          </span><span class=cB7>}</span><span class=cB0>
<a name="l259"></a>        }
<a name="l260"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l261"></a>      x1w-=yh;
<a name="l262"></a>      y1w+=xh;
<a name="l263"></a>    }
<a name="l264"></a>    _x1h-=xh*</span><span class=cBB>mp_cnt</span><span class=cB0>;
<a name="l265"></a>    _y1h-=yh*</span><span class=cBB>mp_cnt</span><span class=cB0>;
<a name="l266"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l267"></a>
<a name="l268"></a>  tmpw=walls_head.next;
<a name="l269"></a>  </span><span class=cB1>while</span><span class=cB0> (tmpw!=&amp;walls_head) </span><span class=cB7>{</span><span class=cB0>
<a name="l270"></a>    </span><span class=cB1>if</span><span class=cB0> (tmpw-&gt;cpu_num==cpu_num) {
<a name="l271"></a>      dc-&gt;color=</span><span class=cB3>YELLOW</span><span class=cB0>;
<a name="l272"></a>      x1=tmpw-&gt;p1.x*SCRN_SCALE/BLUEPRINT_SCALE-man_xx;
<a name="l273"></a>      y1=tmpw-&gt;p1.y*SCRN_SCALE/BLUEPRINT_SCALE-man_yy;
<a name="l274"></a>      x2=tmpw-&gt;p2.x*SCRN_SCALE/BLUEPRINT_SCALE-man_xx;
<a name="l275"></a>      y2=tmpw-&gt;p2.y*SCRN_SCALE/BLUEPRINT_SCALE-man_yy;
<a name="l276"></a>
<a name="l277"></a>      </span><span class=cB2>//The foreshortening distorts Z coordinates in a funny way,</span><span class=cB0>
<a name="l278"></a>      </span><span class=cB2>//so we do the wall in tiny pieces.</span><span class=cB0>
<a name="l279"></a>      n=2*(</span><span class=cB5>AbsI64</span><span class=cB7>(</span><span class=cB0>x2-x1</span><span class=cB7>)</span><span class=cB0>+</span><span class=cB5>AbsI64</span><span class=cB7>(</span><span class=cB0>y2-y1</span><span class=cB7>)</span><span class=cB0>)/SCRN_SCALE;
<a name="l280"></a>      </span><span class=cB1>if</span><span class=cB0> (n&lt;1) n=1;
<a name="l281"></a>      dx=(x2-x1)&lt;&lt;16/n;
<a name="l282"></a>      dy=(y2-y1)&lt;&lt;16/n;
<a name="l283"></a>      xx1=x1&lt;&lt;16;
<a name="l284"></a>      yy1=y1&lt;&lt;16;
<a name="l285"></a>      </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;n;i++) </span><span class=cB7>{</span><span class=cB0>
<a name="l286"></a>        xx2=xx1+dx;
<a name="l287"></a>        yy2=yy1+dy;
<a name="l288"></a>        poly[0].x=xx1&gt;&gt;16;
<a name="l289"></a>        poly[0].y=yy1&gt;&gt;16;
<a name="l290"></a>        poly[0].z=0;
<a name="l291"></a>        poly[1].x=xx2&gt;&gt;16;
<a name="l292"></a>        poly[1].y=yy2&gt;&gt;16;
<a name="l293"></a>        poly[1].z=0;
<a name="l294"></a>        poly[2].x=xx2&gt;&gt;16;
<a name="l295"></a>        poly[2].y=yy2&gt;&gt;16;
<a name="l296"></a>        poly[2].z=WALL_HEIGHT*SCRN_SCALE;
<a name="l297"></a>        poly[3].x=xx1&gt;&gt;16;
<a name="l298"></a>        poly[3].y=yy1&gt;&gt;16;
<a name="l299"></a>        poly[3].z=WALL_HEIGHT*SCRN_SCALE;
<a name="l300"></a>        </span><span class=cB5>GrFillPoly3</span><span class=cB0>(dc,4,poly);
<a name="l301"></a>        xx1=xx2; yy1=yy2;
<a name="l302"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l303"></a>      dc-&gt;color=</span><span class=cB3>BLACK</span><span class=cB0>;
<a name="l304"></a>      dc-&gt;thick=1;
<a name="l305"></a>      </span><span class=cB5>GrLine3</span><span class=cB0>(dc,x1,y1,0,x1,y1,WALL_HEIGHT*SCRN_SCALE);
<a name="l306"></a>      </span><span class=cB5>GrLine3</span><span class=cB0>(dc,x2,y2,0,x2,y2,WALL_HEIGHT*SCRN_SCALE);
<a name="l307"></a>    }
<a name="l308"></a>    tmpw=tmpw-&gt;next;
<a name="l309"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l310"></a>  </span><span class=cB5>Free</span><span class=cB0>(_r3);
<a name="l311"></a>  </span><span class=cB5>Free</span><span class=cB0>(dc-&gt;r);
<a name="l312"></a>  </span><span class=cB5>Free</span><span class=cB0>(dc);
<a name="l313"></a>  </span><span class=cB5>LBtr</span><span class=cB0>(&amp;mp_not_done_flags,cpu_num);
<a name="l314"></a>}
<a name="l315"></a>
<a name="l316"></a></span><span class=cB1>U0</span><span class=cB0> </span><span class=cB5>DrawIt</span><span class=cB0>(</span><span class=cB9>CTask</span><span class=cB0> *task,</span><span class=cB9>CDC</span><span class=cB0> *dc)
<a name="l317"></a>{
<a name="l318"></a>  </span><span class=cB9>I64</span><span class=cB0> i,j,xx,yy,zz,x,y;
<a name="l319"></a>  </span><span class=cB1>U8</span><span class=cB0> *tmps;
<a name="l320"></a>  </span><span class=cB1>F64</span><span class=cB0> tt;
<a name="l321"></a>
<a name="l322"></a>  cx=task-&gt;pix_width/2;
<a name="l323"></a>  cy=task-&gt;pix_height/2;
<a name="l324"></a>
<a name="l325"></a>  </span><span class=cB5>DCDepthBufAlloc</span><span class=cB0>(dc);
<a name="l326"></a>  </span><span class=cB5>MemSet</span><span class=cB0>(panels_processed,0,</span><span class=cB7>(</span><span class=cB0>blueprint_width*blueprint_height+7</span><span class=cB7>)</span><span class=cB0>&gt;&gt;3);
<a name="l327"></a>
<a name="l328"></a>  </span><span class=cB2>//World to scrn</span><span class=cB0>
<a name="l329"></a>  </span><span class=cB5>Mat4x4RotZ</span><span class=cB0>(dc-&gt;r,man_theta+</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l330"></a>  </span><span class=cB5>Mat4x4RotX</span><span class=cB0>(dc-&gt;r,</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l331"></a>  </span><span class=cB5>DCMat4x4Set</span><span class=cB0>(dc,dc-&gt;r);
<a name="l332"></a>
<a name="l333"></a>  xh=-man_xx/SCRN_SCALE; yh=-man_yy/SCRN_SCALE; zh=0;
<a name="l334"></a>  </span><span class=cB5>Mat4x4MulXYZ</span><span class=cB0>(dc-&gt;r,&amp;xh,&amp;yh,&amp;zh);
<a name="l335"></a>  </span><span class=cB5>Mat4x4TranslationEqu</span><span class=cB0>(dc-&gt;r,xh,yh,zh);
<a name="l336"></a>
<a name="l337"></a>  </span><span class=cB2>//Scrn to world</span><span class=cB0>
<a name="l338"></a>  s2w=</span><span class=cB5>Mat4x4IdentNew</span><span class=cB0>(task);
<a name="l339"></a>  </span><span class=cB5>Mat4x4RotX</span><span class=cB0>(s2w,-</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l340"></a>  </span><span class=cB5>Mat4x4RotZ</span><span class=cB0>(s2w,-man_theta-</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l341"></a>  xh=0; yh=0; zh=SCRN_SCALE;
<a name="l342"></a>  </span><span class=cB5>Mat4x4MulXYZ</span><span class=cB0>(s2w,&amp;xh,&amp;yh,&amp;zh);
<a name="l343"></a>
<a name="l344"></a>  </span><span class=cB2>//Rotate light source</span><span class=cB0>
<a name="l345"></a>  xx=dc-&gt;ls.x; yy=dc-&gt;ls.y; zz=-dc-&gt;ls.z;
<a name="l346"></a>  (*dc-&gt;transform)(dc,&amp;xx,&amp;yy,&amp;zz);
<a name="l347"></a>  dc-&gt;ls.x=xx; dc-&gt;ls.y=yy; dc-&gt;ls.z=zz;
<a name="l348"></a>
<a name="l349"></a>  dc-&gt;flags|=</span><span class=cB3>DCF_TRANSFORMATION</span><span class=cB0>;
<a name="l350"></a>  dc-&gt;transform=&amp;DSTransform;
<a name="l351"></a>  dc-&gt;lighting=&amp;DSLighting;
<a name="l352"></a>  dc-&gt;x=cx;
<a name="l353"></a>  dc-&gt;y=cy;
<a name="l354"></a>  r1=</span><span class=cB5>Mat4x4IdentNew</span><span class=cB0>(task);
<a name="l355"></a>  </span><span class=cB5>Mat4x4RotX</span><span class=cB0>(r1,-</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l356"></a>  </span><span class=cB5>Mat4x4RotZ</span><span class=cB0>(r1,</span><span class=cB5>tS</span><span class=cB0>);
<a name="l357"></a>  </span><span class=cB5>Mat4x4Scale</span><span class=cB0>(r1,PERSON_SCALE);
<a name="l358"></a>
<a name="l359"></a>  r2=</span><span class=cB5>Mat4x4IdentNew</span><span class=cB0>(task);
<a name="l360"></a>  </span><span class=cB5>Mat4x4Scale</span><span class=cB0>(r2,PERSON_SCALE);
<a name="l361"></a>
<a name="l362"></a>  r3=</span><span class=cB5>Mat4x4IdentNew</span><span class=cB0>(task);
<a name="l363"></a>  </span><span class=cB5>Mat4x4RotX</span><span class=cB0>(r3,-</span><span class=cB3>pi</span><span class=cB0>/2);
<a name="l364"></a>  </span><span class=cB5>Mat4x4Scale</span><span class=cB0>(r3,PLANT_SCALE);
<a name="l365"></a>
<a name="l366"></a>  x1h=man_xx+yh*PLOT_GRID_WIDTH/2+xh*(PLOT_GRID_HEIGHT-1);
<a name="l367"></a>  y1h=man_yy-xh*PLOT_GRID_WIDTH/2+yh*(PLOT_GRID_HEIGHT-1);
<a name="l368"></a>  xh&gt;&gt;=1; yh&gt;&gt;=1;
<a name="l369"></a>
<a name="l370"></a>  mp_not_done_flags=1&lt;&lt;</span><span class=cBB>mp_cnt</span><span class=cB0>-1;
<a name="l371"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;</span><span class=cBB>mp_cnt</span><span class=cB0>;i++)
<a name="l372"></a>    </span><span class=cB5>JobQue</span><span class=cB0>(&amp;MPDrawWalls,dc,i);
<a name="l373"></a>  </span><span class=cB1>while</span><span class=cB0> (mp_not_done_flags)
<a name="l374"></a>    </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l375"></a>
<a name="l376"></a>    </span><span class=cB2>//Draw Persons</span><span class=cB0>
<a name="l377"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;PERSONS_NUM;i++) </span><span class=cB7>{</span><span class=cB0>
<a name="l378"></a>    x=persons[i].x;
<a name="l379"></a>    y=persons[i].y;
<a name="l380"></a>    </span><span class=cB1>if</span><span class=cB0> (LOS</span><span class=cB7>(</span><span class=cB0>x,y,man_xx,man_yy</span><span class=cB7>)</span><span class=cB0>) {
<a name="l381"></a>      x-=man_xx;
<a name="l382"></a>      y-=man_yy;
<a name="l383"></a>      xx=x;
<a name="l384"></a>      yy=y;
<a name="l385"></a>      zz=0;
<a name="l386"></a>      </span><span class=cB5>DCTransform</span><span class=cB0>(dc,&amp;xx,&amp;yy,&amp;zz);
<a name="l387"></a>      </span><span class=cB1>if</span><span class=cB0> (zz&gt;0) </span><span class=cB7>{</span><span class=cB0>
<a name="l388"></a>        tt=2*</span><span class=cB5>Tri</span><span class=cB0>(</span><span class=cB5>tS</span><span class=cB0>,1.0);
<a name="l389"></a>        </span><span class=cB1>if</span><span class=cB0> (tt&lt;1.0)
<a name="l390"></a>          tmps=</span><span class=cB5>SpriteInterpolate</span><span class=cB0>(tt,</span><span class=cBA>&lt;2&gt;</span><span class=cB0>,</span><span class=cBA>&lt;1&gt;</span><span class=cB0>);
<a name="l391"></a>        </span><span class=cB1>else</span><span class=cB0>
<a name="l392"></a>          tmps=</span><span class=cB5>SpriteInterpolate</span><span class=cB0>(tt-1.0,</span><span class=cBA>&lt;1&gt;</span><span class=cB0>,</span><span class=cBA>&lt;3&gt;</span><span class=cB0>);
<a name="l393"></a>        </span><span class=cB5>Sprite3Mat4x4B</span><span class=cB0>(dc,x,y,0,tmps,r1);
<a name="l394"></a>        </span><span class=cB5>Free</span><span class=cB0>(tmps);
<a name="l395"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l396"></a>    }
<a name="l397"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l398"></a>  </span><span class=cB5>Free</span><span class=cB0>(r1);
<a name="l399"></a>  </span><span class=cB5>Free</span><span class=cB0>(r2);
<a name="l400"></a>  </span><span class=cB5>Free</span><span class=cB0>(r3);
<a name="l401"></a>
<a name="l402"></a>  </span><span class=cB2>//Draw BluePrint heads-up display, scaled 2 pixels</span><span class=cB0>
<a name="l403"></a>  </span><span class=cB5>Free</span><span class=cB0>(dc-&gt;r);
<a name="l404"></a>  </span><span class=cB5>DCMat4x4Set</span><span class=cB0>(dc,</span><span class=cB5>Mat4x4IdentNew</span><span class=cB7>(</span><span class=cB0>task</span><span class=cB7>)</span><span class=cB0>);
<a name="l405"></a>  dc-&gt;x=task-&gt;pix_width -2*blueprint_width;
<a name="l406"></a>  dc-&gt;y=task-&gt;pix_height-2*blueprint_height;
<a name="l407"></a>  dc-&gt;z=0;
<a name="l408"></a>  dc-&gt;transform=&amp;</span><span class=cB5>DCTransform</span><span class=cB0>;
<a name="l409"></a>  dc-&gt;thick=2;
<a name="l410"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;blueprint_height;i++)
<a name="l411"></a>    </span><span class=cB1>for</span><span class=cB0> (j=0;j&lt;blueprint_width;j++) </span><span class=cB7>{</span><span class=cB0>
<a name="l412"></a>      dc-&gt;color=blueprint[(blueprint_height-1-i)*blueprint_width+j];
<a name="l413"></a>      </span><span class=cB5>GrPlot3</span><span class=cB0>(dc,2*j,2*i,0);
<a name="l414"></a>    </span><span class=cB7>}</span><span class=cB0>
<a name="l415"></a>
<a name="l416"></a>    </span><span class=cB2>//Draw Things on heads-up BluePrint</span><span class=cB0>
<a name="l417"></a>  dc-&gt;color=</span><span class=cB3>LTPURPLE</span><span class=cB0>;
<a name="l418"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;PERSONS_NUM;i++)
<a name="l419"></a>    </span><span class=cB5>GrPlot3</span><span class=cB0>(dc,2*</span><span class=cB7>(</span><span class=cB0>persons[i].x/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>,
<a name="l420"></a>          2*</span><span class=cB7>(</span><span class=cB0>blueprint_height-1-persons[i].y/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>,0);
<a name="l421"></a>  dc-&gt;color=</span><span class=cB3>LTCYAN</span><span class=cB0>;
<a name="l422"></a>  </span><span class=cB5>GrPlot3</span><span class=cB0>(dc,2*</span><span class=cB7>(</span><span class=cB0>man_xx/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>,
<a name="l423"></a>        2*</span><span class=cB7>(</span><span class=cB0>blueprint_height-1-man_yy/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>,0);
<a name="l424"></a>
<a name="l425"></a>  dc-&gt;color=</span><span class=cB3>LTGREEN</span><span class=cB0>;
<a name="l426"></a>  </span><span class=cB5>GrLine</span><span class=cB0>(dc,cx-5,cy,cx+5,cy);
<a name="l427"></a>  </span><span class=cB5>GrLine</span><span class=cB0>(dc,cx,cy-5,cx,cy+5);
<a name="l428"></a>  </span><span class=cB5>Free</span><span class=cB0>(s2w);
<a name="l429"></a>}
<a name="l430"></a>
<a name="l431"></a></span><span class=cB1>U0</span><span class=cB0> BluePrintDrawIt(</span><span class=cB9>CTask</span><span class=cB0> *task,</span><span class=cB9>CDC</span><span class=cB0> *dc)
<a name="l432"></a>{
<a name="l433"></a>  task-&gt;text_attr=</span><span class=cB3>BLUE</span><span class=cB0>&lt;&lt;4+</span><span class=cB3>WHITE</span><span class=cB0>;
<a name="l434"></a>  </span><span class=cB5>GrBlot</span><span class=cB0>(dc,</span><span class=cB7>(</span><span class=cB0>task-&gt;pix_width-blueprint_dc-&gt;width</span><span class=cB7>)</span><span class=cB0>&gt;&gt;1,
<a name="l435"></a>        </span><span class=cB7>(</span><span class=cB0>task-&gt;pix_height-blueprint_dc-&gt;height</span><span class=cB7>)</span><span class=cB0>&gt;&gt;1,blueprint_dc);
<a name="l436"></a>}
<a name="l437"></a>
<a name="l438"></a>#</span><span class=cB1>define</span><span class=cB0> MAN_START_X     0
<a name="l439"></a>#</span><span class=cB1>define</span><span class=cB0> MAN_START_Y     1
<a name="l440"></a>
<a name="l441"></a></span><span class=cB1>U0</span><span class=cB0> MakeBluePrint()
<a name="l442"></a>{
<a name="l443"></a>  </span><span class=cB9>I64</span><span class=cB0> msg_code,i,x1,y1,x2,y2,arg1,arg2,color=</span><span class=cB3>WHITE</span><span class=cB0>,cpu_num=0;
<a name="l444"></a>  Wall *tmpw;
<a name="l445"></a>
<a name="l446"></a>  </span><span class=cB5>DCFill</span><span class=cB0>(blueprint_dc,</span><span class=cB3>LTBLUE</span><span class=cB0>);
<a name="l447"></a>
<a name="l448"></a>  </span><span class=cB5>SettingsPush</span><span class=cB0>; </span><span class=cB2>//See </span><a href="https://tosrevive.github.io/TempleOS-Unofficial/Wb/Adam/TaskSettings.html#l3"><span class=cB4>SettingsPush</span></a><span class=cB0>
<a name="l449"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;win_inhibit=</span><span class=cB3>WIG_TASK_DFT</span><span class=cB0>-</span><span class=cB3>WIF_SELF_FOCUS</span><span class=cB0>-</span><span class=cB3>WIF_SELF_BORDER</span><span class=cB0>;
<a name="l450"></a>  </span><span class=cB5>DocClear</span><span class=cB0>;
<a name="l451"></a>
<a name="l452"></a>  </span><span class=cB6>&quot;Draw Floor Plan:</span><span class=cB0>
<a name="l453"></a>
<a name="l454"></a></span><span class=cB6>Walls  in WHITE</span><span class=cB0>
<a name="l455"></a></span><span class=cB6>Tables in BROWN</span><span class=cB0>
<a name="l456"></a></span><span class=cB6>Plants in GREEN</span><span class=cB0>
<a name="l457"></a></span><span class=cB6>  &quot;</span><span class=cB0>;
<a name="l458"></a>
<a name="l459"></a>  </span><span class=cB5>AutoComplete</span><span class=cB0>;
<a name="l460"></a>  </span><span class=cB5>WinBorder</span><span class=cB0>;
<a name="l461"></a>  </span><span class=cB5>WinMax</span><span class=cB0>;
<a name="l462"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;draw_it=&amp;BluePrintDrawIt;
<a name="l463"></a>
<a name="l464"></a>  </span><span class=cB1>do</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l465"></a>    msg_code=</span><span class=cB5>GetMsg</span><span class=cB0>(&amp;arg1,&amp;arg2,
<a name="l466"></a>          1&lt;&lt;</span><span class=cB3>MSG_KEY_DOWN</span><span class=cB0>+1&lt;&lt;</span><span class=cB3>MSG_MS_L_DOWN</span><span class=cB0>+
<a name="l467"></a>          1&lt;&lt;</span><span class=cB3>MSG_MS_R_UP</span><span class=cB0>);
<a name="l468"></a>    </span><span class=cB1>switch</span><span class=cB0> (msg_code) {
<a name="l469"></a>      </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>MSG_MS_R_UP</span><span class=cB0>:
<a name="l470"></a>        i=</span><span class=cB5>PopUpColor</span><span class=cB0>;
<a name="l471"></a>        </span><span class=cB1>if</span><span class=cB0> (i&gt;=0) color=i;
<a name="l472"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l473"></a>      </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>MSG_MS_L_DOWN</span><span class=cB0>:
<a name="l474"></a>        </span><span class=cB1>if</span><span class=cB0> (color==</span><span class=cB3>WHITE</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l475"></a>          arg1-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_width-blueprint_dc-&gt;width)&gt;&gt;1;
<a name="l476"></a>          arg2-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_height-blueprint_dc-&gt;height)&gt;&gt;1;
<a name="l477"></a>          x1=arg1; y1=arg2;
<a name="l478"></a>          x2=arg1; y2=arg2;
<a name="l479"></a>          blueprint_dc-&gt;color=</span><span class=cB3>ROP_XOR</span><span class=cB0>+color^</span><span class=cB3>LTBLUE</span><span class=cB0>;
<a name="l480"></a>          </span><span class=cB1>while</span><span class=cB0> (msg_code!=</span><span class=cB3>MSG_MS_L_UP</span><span class=cB0>) {
<a name="l481"></a>            </span><span class=cB5>GrLine</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l482"></a>            msg_code=</span><span class=cB5>GetMsg</span><span class=cB0>(&amp;arg1,&amp;arg2,
<a name="l483"></a>                  1&lt;&lt;</span><span class=cB3>MSG_MS_L_UP</span><span class=cB0>+1&lt;&lt;</span><span class=cB3>MSG_MS_MOVE</span><span class=cB0>);
<a name="l484"></a>            arg1-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_width-blueprint_dc-&gt;width)&gt;&gt;1;
<a name="l485"></a>            arg2-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_height-blueprint_dc-&gt;height)&gt;&gt;1;
<a name="l486"></a>            </span><span class=cB5>GrLine</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l487"></a>            x2=arg1; y2=arg2;
<a name="l488"></a>          }
<a name="l489"></a>          blueprint_dc-&gt;color=color;
<a name="l490"></a>          </span><span class=cB5>GrLine</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l491"></a>
<a name="l492"></a>          tmpw=</span><span class=cB5>CAlloc</span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>Wall</span><span class=cB7>)</span><span class=cB0>);
<a name="l493"></a>          tmpw-&gt;p1.x=x1;
<a name="l494"></a>          tmpw-&gt;p1.y=blueprint_dc-&gt;height-y1;
<a name="l495"></a>          tmpw-&gt;p2.x=x2;
<a name="l496"></a>          tmpw-&gt;p2.y=blueprint_dc-&gt;height-y2;
<a name="l497"></a>          tmpw-&gt;cpu_num=cpu_num++%</span><span class=cBB>mp_cnt</span><span class=cB0>;
<a name="l498"></a>          </span><span class=cB5>QueIns</span><span class=cB0>(tmpw,walls_head.last);
<a name="l499"></a>        </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>else</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l500"></a>          arg1-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_width-blueprint_dc-&gt;width)&gt;&gt;1;
<a name="l501"></a>          arg2-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_height-blueprint_dc-&gt;height)&gt;&gt;1;
<a name="l502"></a>          x1=arg1; y1=arg2;
<a name="l503"></a>          x2=arg1; y2=arg2;
<a name="l504"></a>          blueprint_dc-&gt;color=</span><span class=cB3>ROP_XOR</span><span class=cB0>+color^</span><span class=cB3>LTBLUE</span><span class=cB0>;
<a name="l505"></a>          </span><span class=cB1>while</span><span class=cB0> (msg_code!=</span><span class=cB3>MSG_MS_L_UP</span><span class=cB0>) {
<a name="l506"></a>            </span><span class=cB5>GrRectB</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l507"></a>            msg_code=</span><span class=cB5>GetMsg</span><span class=cB0>(&amp;arg1,&amp;arg2,
<a name="l508"></a>                  1&lt;&lt;</span><span class=cB3>MSG_MS_L_UP</span><span class=cB0>+1&lt;&lt;</span><span class=cB3>MSG_MS_MOVE</span><span class=cB0>);
<a name="l509"></a>            arg1-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_width-blueprint_dc-&gt;width)&gt;&gt;1;
<a name="l510"></a>            arg2-=(</span><span class=cB5>Fs</span><span class=cB0>-&gt;pix_height-blueprint_dc-&gt;height)&gt;&gt;1;
<a name="l511"></a>            </span><span class=cB5>GrRectB</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l512"></a>            x2=arg1; y2=arg2;
<a name="l513"></a>          }
<a name="l514"></a>          blueprint_dc-&gt;color=color;
<a name="l515"></a>          </span><span class=cB5>GrRectB</span><span class=cB0>(blueprint_dc,x1,y1,x2,y2);
<a name="l516"></a>        </span><span class=cB7>}</span><span class=cB0>
<a name="l517"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l518"></a>      </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>MSG_KEY_DOWN</span><span class=cB0>:
<a name="l519"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l520"></a>    }
<a name="l521"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>while</span><span class=cB0> (msg_code!=</span><span class=cB3>MSG_KEY_DOWN</span><span class=cB0> || !arg1);
<a name="l522"></a>  </span><span class=cB5>GetMsg</span><span class=cB0>(,,1&lt;&lt;</span><span class=cB3>MSG_KEY_UP</span><span class=cB0>);
<a name="l523"></a>
<a name="l524"></a>  </span><span class=cB5>SettingsPop</span><span class=cB0>;
<a name="l525"></a>}
<a name="l526"></a>
<a name="l527"></a></span><span class=cB1>U0</span><span class=cB0> Init()
<a name="l528"></a>{
<a name="l529"></a>  </span><span class=cB9>I64</span><span class=cB0> i,j,x,y,c,c1;
<a name="l530"></a>  </span><span class=cB5>QueInit</span><span class=cB0>(&amp;walls_head);
<a name="l531"></a>
<a name="l532"></a>  blueprint_dc=</span><span class=cB5>DCNew</span><span class=cB0>(BLUEPRINT_SCALE*64,BLUEPRINT_SCALE*64);
<a name="l533"></a>  MakeBluePrint;
<a name="l534"></a>
<a name="l535"></a>  </span><span class=cB5>DocClear</span><span class=cB0>;
<a name="l536"></a>  </span><span class=cB6>&quot;$BG,LTGRAY$%h*c&quot;</span><span class=cB0>,</span><span class=cB3>TEXT_ROWS</span><span class=cB0>/2-1,</span><span class=cB6>'\n'</span><span class=cB0>;
<a name="l537"></a>
<a name="l538"></a>  blueprint_width =blueprint_dc-&gt;width/BLUEPRINT_SCALE;
<a name="l539"></a>  blueprint_height=blueprint_dc-&gt;height/BLUEPRINT_SCALE;
<a name="l540"></a>  </span><span class=cB5>Free</span><span class=cB0>(blueprint);
<a name="l541"></a>  </span><span class=cB5>Free</span><span class=cB0>(panels_processed);
<a name="l542"></a>  blueprint=</span><span class=cB5>MAlloc</span><span class=cB0>(blueprint_width*blueprint_height*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB1>U8</span><span class=cB7>)</span><span class=cB0>);
<a name="l543"></a>  </span><span class=cB5>MemSet</span><span class=cB0>(blueprint,</span><span class=cB3>WHITE</span><span class=cB0>,blueprint_width*blueprint_height);
<a name="l544"></a>  panels_processed=</span><span class=cB5>MAlloc</span><span class=cB0>(</span><span class=cB7>(</span><span class=cB0>blueprint_width*blueprint_height+7</span><span class=cB7>)</span><span class=cB0>&gt;&gt;3);
<a name="l545"></a>
<a name="l546"></a>  </span><span class=cB1>for</span><span class=cB0> (y=1;y&lt;blueprint_height-1;y++)
<a name="l547"></a>    </span><span class=cB1>for</span><span class=cB0> (x=1;x&lt;blueprint_width-1;x++) </span><span class=cB7>{</span><span class=cB0>
<a name="l548"></a>      c=</span><span class=cB3>LTBLUE</span><span class=cB0>;
<a name="l549"></a>      </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;BLUEPRINT_SCALE;i++)
<a name="l550"></a>        </span><span class=cB1>for</span><span class=cB0> (j=0;j&lt;BLUEPRINT_SCALE;j++)
<a name="l551"></a>          </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB7>(</span><span class=cB0>c1=</span><span class=cB5>GrPeek</span><span class=cB0>(blueprint_dc,
<a name="l552"></a>                x*BLUEPRINT_SCALE+i,y*BLUEPRINT_SCALE+j)</span><span class=cB7>)</span><span class=cB0>!=</span><span class=cB3>LTBLUE</span><span class=cB0>)
<a name="l553"></a>            c=c1;
<a name="l554"></a>      blueprint[(blueprint_height-1-y)*blueprint_width+x]=c;
<a name="l555"></a>    </span><span class=cB7>}</span><span class=cB0>
<a name="l556"></a>  </span><span class=cB5>DCDel</span><span class=cB0>(blueprint_dc);
<a name="l557"></a>
<a name="l558"></a>  man_xx=(1+MAN_START_X)*SCRN_SCALE;
<a name="l559"></a>  man_yy=(blueprint_height-1-MAN_START_Y)*SCRN_SCALE;
<a name="l560"></a>  man_theta=0;
<a name="l561"></a>
<a name="l562"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;PERSONS_NUM;i++) </span><span class=cB7>{</span><span class=cB0>
<a name="l563"></a>    </span><span class=cB1>do</span><span class=cB0> {
<a name="l564"></a>      persons[i].x=</span><span class=cB5>RandU64</span><span class=cB0>%(</span><span class=cB7>(</span><span class=cB0>blueprint_width-2</span><span class=cB7>)</span><span class=cB0>*SCRN_SCALE)+SCRN_SCALE;
<a name="l565"></a>      persons[i].y=</span><span class=cB5>RandU64</span><span class=cB0>%(</span><span class=cB7>(</span><span class=cB0>blueprint_height-2</span><span class=cB7>)</span><span class=cB0>*SCRN_SCALE)+SCRN_SCALE;
<a name="l566"></a>    } </span><span class=cB1>while</span><span class=cB0> (blueprint[</span><span class=cB7>(</span><span class=cB0>persons[i].y/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>*blueprint_width+
<a name="l567"></a>          persons[i].x/SCRN_SCALE]==</span><span class=cB3>WHITE</span><span class=cB0>);
<a name="l568"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l569"></a>  tf=0;
<a name="l570"></a>  t0=</span><span class=cB5>tS</span><span class=cB0>;
<a name="l571"></a>}
<a name="l572"></a>
<a name="l573"></a></span><span class=cB1>U0</span><span class=cB0> AnimateTask(</span><span class=cB9>I64</span><span class=cB0>)
<a name="l574"></a>{
<a name="l575"></a>  </span><span class=cB9>I64</span><span class=cB0> i,x,y,dd;
<a name="l576"></a>  </span><span class=cB1>while</span><span class=cB0> (</span><span class=cB3>TRUE</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l577"></a>    dd=0.25*SCRN_SCALE*</span><span class=cB5>Sin</span><span class=cB0>(</span><span class=cB5>tS</span><span class=cB0>/2);
<a name="l578"></a>    </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;PERSONS_NUM;i++) {
<a name="l579"></a>      x=persons[i].x;
<a name="l580"></a>      y=persons[i].y;
<a name="l581"></a>      </span><span class=cB1>if</span><span class=cB0> (i&amp;1)
<a name="l582"></a>        x+=dd;
<a name="l583"></a>      </span><span class=cB1>else</span><span class=cB0>
<a name="l584"></a>        y+=dd;
<a name="l585"></a>      </span><span class=cB1>if</span><span class=cB0> (0&lt;=x&lt;=blueprint_width*SCRN_SCALE &amp;&amp;
<a name="l586"></a>            0&lt;=y&lt;=blueprint_height*SCRN_SCALE &amp;&amp;
<a name="l587"></a>            blueprint[</span><span class=cB7>(</span><span class=cB0>y/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>*blueprint_width+x/SCRN_SCALE]!=</span><span class=cB3>WHITE</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l588"></a>        </span><span class=cB1>if</span><span class=cB0> (blueprint[</span><span class=cB7>(</span><span class=cB0>y/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>*blueprint_width+x/SCRN_SCALE+1]==
<a name="l589"></a>              </span><span class=cB3>WHITE</span><span class=cB0> &amp;&amp; x-</span><span class=cB5>RoundI64</span><span class=cB7>(</span><span class=cB0>x,SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>&gt;SCRN_SCALE/2 ||
<a name="l590"></a>              blueprint[</span><span class=cB7>(</span><span class=cB0>y/SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>*blueprint_width+x/SCRN_SCALE-1]==
<a name="l591"></a>              </span><span class=cB3>WHITE</span><span class=cB0> &amp;&amp; x-</span><span class=cB5>RoundI64</span><span class=cB7>(</span><span class=cB0>x,SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>&lt;SCRN_SCALE/2)
<a name="l592"></a>          x=</span><span class=cB5>RoundI64</span><span class=cB0>(x,SCRN_SCALE)+SCRN_SCALE/2;
<a name="l593"></a>        </span><span class=cB1>if</span><span class=cB0> (blueprint[</span><span class=cB7>(</span><span class=cB0>y/SCRN_SCALE+1</span><span class=cB7>)</span><span class=cB0>*blueprint_width+x/SCRN_SCALE]==
<a name="l594"></a>              </span><span class=cB3>WHITE</span><span class=cB0> &amp;&amp; y-</span><span class=cB5>RoundI64</span><span class=cB7>(</span><span class=cB0>y,SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>&gt;SCRN_SCALE/2 ||
<a name="l595"></a>              blueprint[</span><span class=cB7>(</span><span class=cB0>y/SCRN_SCALE-1</span><span class=cB7>)</span><span class=cB0>*blueprint_width+x/SCRN_SCALE]==
<a name="l596"></a>              </span><span class=cB3>WHITE</span><span class=cB0> &amp;&amp; y-</span><span class=cB5>RoundI64</span><span class=cB7>(</span><span class=cB0>y,SCRN_SCALE</span><span class=cB7>)</span><span class=cB0>&lt;SCRN_SCALE/2)
<a name="l597"></a>          y=</span><span class=cB5>RoundI64</span><span class=cB0>(y,SCRN_SCALE)+SCRN_SCALE/2;
<a name="l598"></a>        persons[i].x=x;
<a name="l599"></a>        persons[i].y=y;
<a name="l600"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l601"></a>    }
<a name="l602"></a>    </span><span class=cB5>Sleep</span><span class=cB0>(20);
<a name="l603"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l604"></a>}
<a name="l605"></a>
<a name="l606"></a></span><span class=cB1>U0</span><span class=cB0> CleanUp()
<a name="l607"></a>{
<a name="l608"></a>  </span><span class=cB5>Free</span><span class=cB0>(blueprint);
<a name="l609"></a>  blueprint=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l610"></a>  </span><span class=cB5>Free</span><span class=cB0>(panels_processed);
<a name="l611"></a>  panels_processed=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l612"></a>  </span><span class=cB5>QueDel</span><span class=cB0>(&amp;walls_head);
<a name="l613"></a>}
<a name="l614"></a>
<a name="l615"></a></span><span class=cB1>U0</span><span class=cB0> SongTask(</span><span class=cB9>I64</span><span class=cB0>)
<a name="l616"></a>{ </span><span class=cB2>//Song by Terry A. Davis</span><span class=cB0>
<a name="l617"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;task_end_cb=&amp;</span><span class=cB5>SndTaskEndCB</span><span class=cB0>;
<a name="l618"></a>  </span><span class=cB5>MusicSettingsRst</span><span class=cB0>;
<a name="l619"></a>  </span><span class=cB1>while</span><span class=cB0> (</span><span class=cB3>TRUE</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l620"></a>    </span><span class=cB5>Play</span><span class=cB0>(</span><span class=cB6>&quot;3q.A#eGAeA#qAq.A#eGeAeA#qA&quot;</span><span class=cB0>);
<a name="l621"></a>    </span><span class=cB5>Play</span><span class=cB0>(</span><span class=cB6>&quot;3q.A#eGA#AqGq.A#eGA#AqG&quot;</span><span class=cB0>);
<a name="l622"></a>    </span><span class=cB5>Play</span><span class=cB0>(</span><span class=cB6>&quot;4eA#AqGeA#AqGeA#AGAA#AqG&quot;</span><span class=cB0>);
<a name="l623"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l624"></a>}
<a name="l625"></a>
<a name="l626"></a></span><span class=cB1>U0</span><span class=cB0> MoveMan(</span><span class=cB1>F64</span><span class=cB0> theta)
<a name="l627"></a>{
<a name="l628"></a>  </span><span class=cB9>I64</span><span class=cB0> x,y,color,step=SCRN_SCALE/2;
<a name="l629"></a>  </span><span class=cB1>do</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l630"></a>    x=man_xx+step*</span><span class=cB5>Cos</span><span class=cB0>(theta);
<a name="l631"></a>    y=man_yy-step*</span><span class=cB5>Sin</span><span class=cB0>(theta);
<a name="l632"></a>    x=</span><span class=cB5>Clamp</span><span class=cB0>(x,0,blueprint_width*SCRN_SCALE);
<a name="l633"></a>    y=</span><span class=cB5>Clamp</span><span class=cB0>(y,0,blueprint_height*SCRN_SCALE);
<a name="l634"></a>    color=blueprint[y/SCRN_SCALE*blueprint_width+x/SCRN_SCALE];
<a name="l635"></a>    </span><span class=cB1>if</span><span class=cB0> (color==</span><span class=cB3>LTBLUE</span><span class=cB0> || color==</span><span class=cB3>GREEN</span><span class=cB0>) {
<a name="l636"></a>      man_xx=x;
<a name="l637"></a>      man_yy=y;
<a name="l638"></a>      </span><span class=cB1>break</span><span class=cB0>;
<a name="l639"></a>    } </span><span class=cB1>else</span><span class=cB0>
<a name="l640"></a>      step&gt;&gt;=1;
<a name="l641"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>while</span><span class=cB0> (step);
<a name="l642"></a>}
<a name="l643"></a>
<a name="l644"></a>#</span><span class=cB1>define</span><span class=cB0> MICRO_STEPS     4
<a name="l645"></a></span><span class=cB1>U0</span><span class=cB0> RotateMan(</span><span class=cB1>F64</span><span class=cB0> d)
<a name="l646"></a>{
<a name="l647"></a>  </span><span class=cB9>I64</span><span class=cB0> i;
<a name="l648"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;MICRO_STEPS;i++) </span><span class=cB7>{</span><span class=cB0>
<a name="l649"></a>    man_theta+=d/MICRO_STEPS;
<a name="l650"></a>    </span><span class=cB5>Sleep</span><span class=cB0>(15);
<a name="l651"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l652"></a>}
<a name="l653"></a>
<a name="l654"></a></span><span class=cB1>U0</span><span class=cB0> DiningStars()
<a name="l655"></a>{
<a name="l656"></a>  </span><span class=cB9>I64</span><span class=cB0> sc;
<a name="l657"></a>  </span><span class=cB5>MenuPush</span><span class=cB0>(
<a name="l658"></a>        </span><span class=cB6>&quot;File {&quot;</span><span class=cB0>
<a name="l659"></a>        </span><span class=cB6>&quot;  Abort(,CH_SHIFT_ESC);&quot;</span><span class=cB0>
<a name="l660"></a>        </span><span class=cB6>&quot;  Exit(,CH_ESC);&quot;</span><span class=cB0>
<a name="l661"></a>        </span><span class=cB6>&quot;}&quot;</span><span class=cB0>
<a name="l662"></a>        </span><span class=cB6>&quot;Play {&quot;</span><span class=cB0>
<a name="l663"></a>        </span><span class=cB6>&quot;  Fwd(,,SC_CURSOR_UP);&quot;</span><span class=cB0>
<a name="l664"></a>        </span><span class=cB6>&quot;  Bwd(,,SC_CURSOR_DOWN);&quot;</span><span class=cB0>
<a name="l665"></a>        </span><span class=cB6>&quot;  Left(,,SC_CURSOR_LEFT);&quot;</span><span class=cB0>
<a name="l666"></a>        </span><span class=cB6>&quot;  Right(,,SC_CURSOR_RIGHT);&quot;</span><span class=cB0>
<a name="l667"></a>        </span><span class=cB6>&quot;}&quot;</span><span class=cB0>
<a name="l668"></a>        );
<a name="l669"></a>
<a name="l670"></a>  </span><span class=cB5>SettingsPush</span><span class=cB0>; </span><span class=cB2>//See </span><a href="https://tosrevive.github.io/TempleOS-Unofficial/Wb/Adam/TaskSettings.html#l3"><span class=cB4>SettingsPush</span></a><span class=cB0>
<a name="l671"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;text_attr=</span><span class=cB3>BROWN</span><span class=cB0>&lt;&lt;4+</span><span class=cB3>WHITE</span><span class=cB0>;
<a name="l672"></a>  </span><span class=cB5>AutoComplete</span><span class=cB0>;
<a name="l673"></a>  </span><span class=cB5>WinBorder</span><span class=cB0>;
<a name="l674"></a>  </span><span class=cB5>WinMax</span><span class=cB0>;
<a name="l675"></a>  </span><span class=cB5>DocCursor</span><span class=cB0>;
<a name="l676"></a>  Init;
<a name="l677"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;animate_task=</span><span class=cB5>Spawn</span><span class=cB0>(&amp;AnimateTask,</span><span class=cB3>NULL</span><span class=cB0>,</span><span class=cB6>&quot;Animate&quot;</span><span class=cB0>,,</span><span class=cB5>Fs</span><span class=cB0>);
<a name="l678"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;song_task=</span><span class=cB5>Spawn</span><span class=cB0>(&amp;SongTask,</span><span class=cB3>NULL</span><span class=cB0>,</span><span class=cB6>&quot;Song&quot;</span><span class=cB0>,,</span><span class=cB5>Fs</span><span class=cB0>);
<a name="l679"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;draw_it=&amp;</span><span class=cB5>DrawIt</span><span class=cB0>;
<a name="l680"></a>
<a name="l681"></a>  </span><span class=cB1>try</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l682"></a>    </span><span class=cB1>while</span><span class=cB0> (</span><span class=cB3>TRUE</span><span class=cB0>) {
<a name="l683"></a>      </span><span class=cB1>switch</span><span class=cB0> (</span><span class=cB5>GetKey</span><span class=cB7>(</span><span class=cB0>&amp;sc</span><span class=cB7>)</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l684"></a>        </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>CH_ESC</span><span class=cB0>:
<a name="l685"></a>        </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>CH_SHIFT_ESC</span><span class=cB0>:
<a name="l686"></a>          </span><span class=cB1>goto</span><span class=cB0> fs_done;
<a name="l687"></a>        </span><span class=cB1>case</span><span class=cB0> 0:
<a name="l688"></a>          </span><span class=cB1>switch</span><span class=cB0> (sc.u8[0]) {
<a name="l689"></a>            </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>SC_CURSOR_RIGHT</span><span class=cB0>:
<a name="l690"></a>              </span><span class=cB5>Spawn</span><span class=cB0>(&amp;RotateMan,</span><span class=cB7>(</span><span class=cB3>pi</span><span class=cB0>/32</span><span class=cB7>)(</span><span class=cB9>I64</span><span class=cB7>)</span><span class=cB0>);
<a name="l691"></a>              </span><span class=cB1>break</span><span class=cB0>;
<a name="l692"></a>            </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>SC_CURSOR_LEFT</span><span class=cB0>:
<a name="l693"></a>              </span><span class=cB5>Spawn</span><span class=cB0>(&amp;RotateMan,</span><span class=cB7>(</span><span class=cB0>-</span><span class=cB3>pi</span><span class=cB0>/32</span><span class=cB7>)(</span><span class=cB9>I64</span><span class=cB7>)</span><span class=cB0>);
<a name="l694"></a>              </span><span class=cB1>break</span><span class=cB0>;
<a name="l695"></a>            </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>SC_CURSOR_UP</span><span class=cB0>:
<a name="l696"></a>              MoveMan(man_theta);
<a name="l697"></a>              </span><span class=cB1>break</span><span class=cB0>;
<a name="l698"></a>            </span><span class=cB1>case</span><span class=cB0> </span><span class=cB3>SC_CURSOR_DOWN</span><span class=cB0>:
<a name="l699"></a>              MoveMan(man_theta+</span><span class=cB3>pi</span><span class=cB0>);
<a name="l700"></a>              </span><span class=cB1>break</span><span class=cB0>;
<a name="l701"></a>          }
<a name="l702"></a>          </span><span class=cB1>break</span><span class=cB0>;
<a name="l703"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l704"></a>    }
<a name="l705"></a>fs_done:
<a name="l706"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>catch</span><span class=cB0>
<a name="l707"></a>    </span><span class=cB5>PutExcept</span><span class=cB0>;
<a name="l708"></a>  </span><span class=cB5>DocClear</span><span class=cB0>;
<a name="l709"></a>  </span><span class=cB5>SettingsPop</span><span class=cB0>;
<a name="l710"></a>  CleanUp;
<a name="l711"></a>  </span><span class=cB5>MenuPop</span><span class=cB0>;
<a name="l712"></a>  </span><span class=cB5>RegWrite</span><span class=cB0>(</span><span class=cB6>&quot;TempleOS/DiningStars&quot;</span><span class=cB0>,</span><span class=cB6>&quot;F64 best_score=%5.4f;\n&quot;</span><span class=cB0>,best_score);
<a name="l713"></a>}
<a name="l714"></a>
<a name="l715"></a>DiningStars;
</span></div></pre></body>
</html>
