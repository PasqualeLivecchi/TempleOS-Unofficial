<!DOCTYPE HTML>
<html style="background-color:#FFFFFF;">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=US-ASCII">
<title>The Temple Operating System</title>
<meta name="keywords" content="Operating System,64-Bit,64 Bit,Temple,OS,TempleOS,Free,Open Source,Public Domain,x86_64">
<meta name="generator" content="TempleOS (U) V5.04">
<style type="text/css">
.cB0{color:#000000;background-color:#55ffff;}
.cB1{color:#0000aa;background-color:#55ffff;}
.cB2{color:#00aa00;background-color:#55ffff;}
.cB3{color:#00aaaa;background-color:#55ffff;}
.cB5{color:#aa00aa;background-color:#55ffff;}
.cB6{color:#aa5500;background-color:#55ffff;}
.cB7{color:#aaaaaa;background-color:#55ffff;}
.cB9{color:#5555ff;background-color:#55ffff;}
.cBB{color:#55ffff;background-color:#55ffff;}
.cF0{color:#000000;background-color:#ffffff;}
.cF1{color:#0000aa;background-color:#ffffff;}
.cF2{color:#00aa00;background-color:#ffffff;}
.cF3{color:#00aaaa;background-color:#ffffff;}
.cF4{color:#aa0000;background-color:#ffffff;}
.cF5{color:#aa00aa;background-color:#ffffff;}
.cF6{color:#aa5500;background-color:#ffffff;}
.cF7{color:#aaaaaa;background-color:#ffffff;}
.cF8{color:#555555;background-color:#ffffff;}
.cF9{color:#5555ff;background-color:#ffffff;}
.cFA{color:#55ff55;background-color:#ffffff;}
.cFB{color:#55ffff;background-color:#ffffff;}
.cFC{color:#ff5555;background-color:#ffffff;}
.cFD{color:#ff55ff;background-color:#ffffff;}
.cFE{color:#ffff55;background-color:#ffffff;}
.cFF{color:#ffffff;background-color:#ffffff;}
</style>
</head>
<body style="background-color:#55FFFF; border-style:solid;
	  border-width:8px; border-color:#0000AA;
	  margin-left:auto; margin-right:auto; width:800px; ">
<pre style="font-family:courier;font-size:10pt">
<div style="margin-left:auto; margin-right:auto; width: 640px;">
<a name="l1"></a><span class=cB5>AdamFile</span><span class=cB0>(</span><span class=cB6>&quot;../Sup1CodeScraps/Mem/Mem2Meg.HC&quot;</span><span class=cB0>);
<a name="l2"></a>
<a name="l3"></a>#</span><span class=cB1>help_index</span><span class=cB0> </span><span class=cB6>&quot;Snd/HDAudio&quot;</span><span class=cB0>
<a name="l4"></a>
<a name="l5"></a></span><span class=cB2>//snd devs</span><span class=cB0>
<a name="l6"></a>#</span><span class=cB1>define</span><span class=cB0> SD_PC_SPEAKER           0
<a name="l7"></a>#</span><span class=cB1>define</span><span class=cB0> SD_HD_AUDIO             1
<a name="l8"></a>
<a name="l9"></a>#</span><span class=cB1>define</span><span class=cB0> SND_SAMPLE_RATE         48000
<a name="l10"></a>#</span><span class=cB1>define</span><span class=cB0> SND_SAMPLE_BITS         24
<a name="l11"></a>#</span><span class=cB1>define</span><span class=cB0> SND_OCHANNELS           2
<a name="l12"></a>#</span><span class=cB1>define</span><span class=cB0> SND_ICHANNELS           2
<a name="l13"></a>#</span><span class=cB1>define</span><span class=cB0> SND_OUT_CONTAINER       </span><span class=cB9>I32</span><span class=cB0>
<a name="l14"></a>#</span><span class=cB1>define</span><span class=cB0> SND_IN_CONTAINER        </span><span class=cB9>I16</span><span class=cB0>
<a name="l15"></a>#</span><span class=cB1>define</span><span class=cB0> SND_BUF_LEN             0x400
<a name="l16"></a>#</span><span class=cB1>define</span><span class=cB0> SND_BUF_TIME_mS         (SND_BUF_LEN/SND_OCHANNELS*1000.0/\
<a name="l17"></a>                                SND_SAMPLE_RATE)
<a name="l18"></a>
<a name="l19"></a></span><span class=cB1>F64</span><span class=cB0> snd_freq=0;
<a name="l20"></a></span><span class=cB9>I64</span><span class=cB0> snd_dev=SD_PC_SPEAKER;
<a name="l21"></a></span><span class=cB1>Bool</span><span class=cB0> snd_record=</span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l22"></a></span><span class=cB1>F64</span><span class=cB0> snd_vol=0.1;
<a name="l23"></a></span><span class=cB1>U0</span><span class=cB0> (*fp_snd)(</span><span class=cB1>F64</span><span class=cB0> freq,</span><span class=cB9>I64</span><span class=cB0> waveform,</span><span class=cB1>F64</span><span class=cB0> amp)=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l24"></a></span><span class=cB1>U0</span><span class=cB0> (*fp_snd_record)(</span><span class=cB1>F64</span><span class=cB0> freq,</span><span class=cB9>I64</span><span class=cB0> waveform,</span><span class=cB1>F64</span><span class=cB0> amp)=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l25"></a></span><span class=cB1>U0</span><span class=cB0> (*fp_snd_fill_buf)(SND_OUT_CONTAINER *buf,</span><span class=cB9>I64</span><span class=cB0> buf_num)=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l26"></a></span><span class=cB1>U0</span><span class=cB0> (*fp_snd_copy_buf)(SND_IN_CONTAINER *buf,</span><span class=cB9>I64</span><span class=cB0> buf_num)=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l27"></a>
<a name="l28"></a></span><span class=cB9>I64</span><span class=cB0> snd_obuf_num,snd_ibuf_num;
<a name="l29"></a>
<a name="l30"></a>#</span><span class=cB1>define</span><span class=cB0> Sf_FILLING_OUT          0
<a name="l31"></a></span><span class=cB9>I64</span><span class=cB0> snd_flags;
<a name="l32"></a>
<a name="l33"></a>#</span><span class=cB1>define</span><span class=cB0> HD_1_CHAN       0
<a name="l34"></a>#</span><span class=cB1>define</span><span class=cB0> HD_2_CHAN       1
<a name="l35"></a>#</span><span class=cB1>define</span><span class=cB0> HD_3_CHAN       2
<a name="l36"></a>#</span><span class=cB1>define</span><span class=cB0> HD_4_CHAN       3
<a name="l37"></a>
<a name="l38"></a>#</span><span class=cB1>define</span><span class=cB0> HD_8_BIT        0
<a name="l39"></a>#</span><span class=cB1>define</span><span class=cB0> HD_16_BIT       1
<a name="l40"></a>#</span><span class=cB1>define</span><span class=cB0> HD_20_BIT       2
<a name="l41"></a>#</span><span class=cB1>define</span><span class=cB0> HD_24_BIT       3
<a name="l42"></a>#</span><span class=cB1>define</span><span class=cB0> HD_32_BIT       4
<a name="l43"></a>
<a name="l44"></a>#</span><span class=cB1>define</span><span class=cB0> HD_48kHz        0
<a name="l45"></a>
<a name="l46"></a>#</span><span class=cB1>define</span><span class=cB0> HD_DFT_OUT_FMT  (HD_2_CHAN+HD_24_BIT&lt;&lt;4+HD_48kHz&lt;&lt;8)
<a name="l47"></a>#</span><span class=cB1>define</span><span class=cB0> HD_DFT_IN_FMT   (HD_2_CHAN+HD_16_BIT&lt;&lt;4+HD_48kHz&lt;&lt;8)
<a name="l48"></a>
<a name="l49"></a>#</span><span class=cB1>define</span><span class=cB0> HD_POS_BUF_MULTIPLES    0x1000
<a name="l50"></a>
<a name="l51"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORB_ENTRIES 256
<a name="l52"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRB_ENTRIES 256
<a name="l53"></a>#</span><span class=cB1>define</span><span class=cB0> HD_BDL_ENTRIES  256
<a name="l54"></a>
<a name="l55"></a>#</span><span class=cB1>define</span><span class=cB0> HD_GCTL         0x08
<a name="l56"></a>#</span><span class=cB1>define</span><span class=cB0> HD_STATESTS     0x0E
<a name="l57"></a>#</span><span class=cB1>define</span><span class=cB0> HD_GSTS         0x10
<a name="l58"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBLBASE    0x40
<a name="l59"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBUBASE    0x44
<a name="l60"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBWP       0x48
<a name="l61"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBRP       0x4A
<a name="l62"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBCTL      0x4C
<a name="l63"></a>#</span><span class=cB1>define</span><span class=cB0> HD_CORBST       0x4D
<a name="l64"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRBLBASE    0x50
<a name="l65"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRBUBASE    0x54
<a name="l66"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRBWP       0x58
<a name="l67"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRBCTL      0x5C
<a name="l68"></a>#</span><span class=cB1>define</span><span class=cB0> HD_RIRBSTS      0x5D
<a name="l69"></a>
<a name="l70"></a>#</span><span class=cB1>define</span><span class=cB0> STRCTL          0x00
<a name="l71"></a>#</span><span class=cB1>define</span><span class=cB0> STRSTS          0x03
<a name="l72"></a>#</span><span class=cB1>define</span><span class=cB0> STRLPIB         0x04
<a name="l73"></a>#</span><span class=cB1>define</span><span class=cB0> STRCBL          0x08
<a name="l74"></a>#</span><span class=cB1>define</span><span class=cB0> STRLVI          0x0C
<a name="l75"></a>#</span><span class=cB1>define</span><span class=cB0> STRFIFOW        0x0E
<a name="l76"></a>#</span><span class=cB1>define</span><span class=cB0> STRFIFOS        0x10
<a name="l77"></a>#</span><span class=cB1>define</span><span class=cB0> STRFMT          0x12
<a name="l78"></a>#</span><span class=cB1>define</span><span class=cB0> STRBDPL         0x18
<a name="l79"></a>#</span><span class=cB1>define</span><span class=cB0> STRBDPU         0x1C
<a name="l80"></a>
<a name="l81"></a>#</span><span class=cB1>define</span><span class=cB0> ISTR0           0x080
<a name="l82"></a>#</span><span class=cB1>define</span><span class=cB0> ISTR1           0x0A0
<a name="l83"></a>#</span><span class=cB1>define</span><span class=cB0> ISTR2           0x0C0
<a name="l84"></a>#</span><span class=cB1>define</span><span class=cB0> ISTR3           0x0E0
<a name="l85"></a>#</span><span class=cB1>define</span><span class=cB0> OSTR0           0x100
<a name="l86"></a>#</span><span class=cB1>define</span><span class=cB0> OSTR1           0x120
<a name="l87"></a>#</span><span class=cB1>define</span><span class=cB0> OSTR2           0x140
<a name="l88"></a>#</span><span class=cB1>define</span><span class=cB0> OSTR3           0x160
<a name="l89"></a>
<a name="l90"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GET_PARAM          0xF0000
<a name="l91"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CONNECT_SEL_GET    0xF0100
<a name="l92"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CONNECT_SEL_SET    0x70100
<a name="l93"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GET_CONNECT_LST    0xF0200
<a name="l94"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PROCESS_STATE_GET  0xF0300
<a name="l95"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PROCESS_STATE_SET  0x70300
<a name="l96"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_COEFF_IDX_GET      0xD0000
<a name="l97"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_COEFF_IDX_SET      0x50000
<a name="l98"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PROCESS_COEFF_GET  0xC0000
<a name="l99"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PROCESS_COEFF_SET  0x40000
<a name="l100"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_AMPLIFIER_GAIN_GET 0xB0000
<a name="l101"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_AMPLIFIER_GAIN_SET 0x30000
<a name="l102"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_STREAM_FMT_GET     0xA0000
<a name="l103"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_STREAM_FMT_SET     0x20000
<a name="l104"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_DIGIT_CONVERT1_GET 0xF0D00
<a name="l105"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_DIGIT_CONVERT1_SET 0x70D00
<a name="l106"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_DIGIT_CONVERT2_GET 0xF0D00
<a name="l107"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_DIGIT_CONVERT2_SET 0x70E00
<a name="l108"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_POWER_STATE_GET    0xF0500
<a name="l109"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_POWER_STATE_SET    0x70500
<a name="l110"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CHAN_STREAM_ID_GET 0xF0600
<a name="l111"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CHAN_STREAM_ID_SET 0x70600
<a name="l112"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SDI_SEL_GET        0xF0400
<a name="l113"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SDI_SEL_SET        0x70400
<a name="l114"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PIN_WIDGET_CTL_GET 0xF0700
<a name="l115"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PIN_WIDGET_CTL_SET 0x70700
<a name="l116"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_UNSOL_ENABLE_GET   0xF0800
<a name="l117"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_UNSOL_ENABLE_SET   0x70800
<a name="l118"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PIN_SENSE_GET      0xF0900
<a name="l119"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_PIN_SENSE_SET      0x70900
<a name="l120"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_EAPDBTL_ENABLE_GET 0xF0C00
<a name="l121"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_EAPDBTL_ENABLE_SET 0x70C00
<a name="l122"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_BEEP_CTL_GET       0xF0A00
<a name="l123"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_BEEP_CTL_SET       0x70A00
<a name="l124"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL0_GET      0xF1000
<a name="l125"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL0_SET      0x71000
<a name="l126"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL1_GET      0xF1100
<a name="l127"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL1_SET      0x71100
<a name="l128"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL2_GET      0xF1200
<a name="l129"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL2_SET      0x71200
<a name="l130"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL3_GET      0xF1300
<a name="l131"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL3_SET      0x71300
<a name="l132"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL4_GET      0xF1400
<a name="l133"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL4_SET      0x71400
<a name="l134"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL5_GET      0xF1500
<a name="l135"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL5_SET      0x71500
<a name="l136"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL6_GET      0xF1600
<a name="l137"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL6_SET      0x71600
<a name="l138"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL7_GET      0xF1700
<a name="l139"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL7_SET      0x71700
<a name="l140"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL8_GET      0xF1800
<a name="l141"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL8_SET      0x71800
<a name="l142"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL9_GET      0xF1900
<a name="l143"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRL9_SET      0x71900
<a name="l144"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRLA_GET      0xF1A00
<a name="l145"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_GPI_CTRLA_SET      0x71A00
<a name="l146"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_VOL_CTL_GET        0xF0F00
<a name="l147"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_VOL_CTL_SET        0x70F00
<a name="l148"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID0_GET    0xF2000
<a name="l149"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID0_SET    0x72000
<a name="l150"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID1_GET    0xF2000
<a name="l151"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID1_SET    0x72100
<a name="l152"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID2_GET    0xF2000
<a name="l153"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID2_SET    0x72200
<a name="l154"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID3_GET    0xF2000
<a name="l155"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_SUB_SYS_ID3_SET    0x72300
<a name="l156"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT0_GET       0xF1C00
<a name="l157"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT0_SET       0x71C00
<a name="l158"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT1_GET       0xF1C00
<a name="l159"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT1_SET       0x71D00
<a name="l160"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT2_GET       0xF1C00
<a name="l161"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT2_SET       0x71E00
<a name="l162"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT3_GET       0xF1C00
<a name="l163"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_CFG_DFT3_SET       0x71F00
<a name="l164"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_STRIPE_CTL_GET     0xF2400
<a name="l165"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_STRIPE_CTL_SET     0x72400
<a name="l166"></a>#</span><span class=cB1>define</span><span class=cB0> VERB_RST                0x7FF00
<a name="l167"></a>
<a name="l168"></a></span><span class=cB2>//Parameters</span><span class=cB0>
<a name="l169"></a>#</span><span class=cB1>define</span><span class=cB0> P_VENDOR_ID             0x00
<a name="l170"></a>#</span><span class=cB1>define</span><span class=cB0> P_REVISION_ID           0x02
<a name="l171"></a>#</span><span class=cB1>define</span><span class=cB0> P_SUBNODE_CNT           0x04
<a name="l172"></a>#</span><span class=cB1>define</span><span class=cB0> P_FUN_GRP_TYPE          0x05
<a name="l173"></a>#</span><span class=cB1>define</span><span class=cB0> P_AUDIO_FUN_CAP         0x08
<a name="l174"></a>#</span><span class=cB1>define</span><span class=cB0> P_AUDIO_WIDGET_CAP      0x09
<a name="l175"></a>#</span><span class=cB1>define</span><span class=cB0> P_SAMPLE_SIZE_RATE_CAP  0x0A
<a name="l176"></a>#</span><span class=cB1>define</span><span class=cB0> P_STREAM_FMTS           0x0B
<a name="l177"></a>#</span><span class=cB1>define</span><span class=cB0> P_PIN_CAP               0x0C
<a name="l178"></a>#</span><span class=cB1>define</span><span class=cB0> P_INPUT_AMP_CAP         0x0D
<a name="l179"></a>#</span><span class=cB1>define</span><span class=cB0> P_OUTPUT_AMP_CAP        0x12
<a name="l180"></a>#</span><span class=cB1>define</span><span class=cB0> P_CONNECT_LST_LEN       0x0E
<a name="l181"></a>#</span><span class=cB1>define</span><span class=cB0> P_POWER_STATES          0x0F
<a name="l182"></a>#</span><span class=cB1>define</span><span class=cB0> P_PROCESSING_CAP        0x10
<a name="l183"></a>#</span><span class=cB1>define</span><span class=cB0> P_GPIO_CNT              0x11
<a name="l184"></a>#</span><span class=cB1>define</span><span class=cB0> P_VOL_KNOB_CAP  0x13
<a name="l185"></a>
<a name="l186"></a></span><span class=cB2>//Function Group Types</span><span class=cB0>
<a name="l187"></a></span><span class=cB2>//00 reserved</span><span class=cB0>
<a name="l188"></a>#</span><span class=cB1>define</span><span class=cB0> FGT_AUDIO               1
<a name="l189"></a>#</span><span class=cB1>define</span><span class=cB0> FGT_VENDOR_MODEM        2
<a name="l190"></a></span><span class=cB2>//03-7F reserved</span><span class=cB0>
<a name="l191"></a></span><span class=cB2>//80-FF vendor function group</span><span class=cB0>
<a name="l192"></a>
<a name="l193"></a></span><span class=cB2>//Audio Widget Types</span><span class=cB0>
<a name="l194"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_OUTPUT              0x0
<a name="l195"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_INPUT               0x1
<a name="l196"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_MIXER               0x2
<a name="l197"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_SELECTOR            0x3
<a name="l198"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_PIN_COMPLEX         0x4
<a name="l199"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_POWER_WIDGET        0x5
<a name="l200"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_VOL_KNOB_WIDGET     0x6
<a name="l201"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_BEEP_GEN_WIDGET     0x7
<a name="l202"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_VENDOR              0xF
<a name="l203"></a>#</span><span class=cB1>define</span><span class=cB0> AWT_NODE                0x10
<a name="l204"></a></span><span class=cB5>DefineLstLoad</span><span class=cB0>(</span><span class=cB6>&quot;ST_AUDIO_WIDGET_TYPES&quot;</span><span class=cB0>,
<a name="l205"></a></span><span class=cB6>&quot;Output\0Input\0Mixer\0Sellector\0Pin Complex\0&quot;</span><span class=cB0>
<a name="l206"></a></span><span class=cB6>&quot;Power Widget\0Vol Knob\0Beep Gen\0 \0 \0 \0 \0 \0 \0 \0Vendor\0Node\0&quot;</span><span class=cB0>);
<a name="l207"></a>
<a name="l208"></a></span><span class=cB1>class</span><span class=cB0> CHDBufDesc
<a name="l209"></a>{
<a name="l210"></a>  </span><span class=cB9>I32</span><span class=cB0> *buf;
<a name="l211"></a>  </span><span class=cB9>U32</span><span class=cB0> len;
<a name="l212"></a>  </span><span class=cB9>U32</span><span class=cB0> ctrl;
<a name="l213"></a>};
<a name="l214"></a>
<a name="l215"></a>#</span><span class=cB1>define</span><span class=cB0> HD_TONES        8
<a name="l216"></a>
<a name="l217"></a></span><span class=cB1>class</span><span class=cB0> CHDAudioCtrl
<a name="l218"></a>{
<a name="l219"></a>  </span><span class=cB1>U8</span><span class=cB0> *bar;
<a name="l220"></a>  </span><span class=cB9>CBlkPool</span><span class=cB0> *bp;
<a name="l221"></a>  </span><span class=cB9>CHeapCtrl</span><span class=cB0> *hc;
<a name="l222"></a>  </span><span class=cB9>I64</span><span class=cB0> cad;
<a name="l223"></a>  </span><span class=cB9>U32</span><span class=cB0> *corb;
<a name="l224"></a>  </span><span class=cB9>I64</span><span class=cB0> *rirb;
<a name="l225"></a>  CHDBufDesc *ostr0_bdl,*istr0_bdl;
<a name="l226"></a>  SND_OUT_CONTAINER *ostr0_buf[2],*o_tmp_buf;
<a name="l227"></a>  SND_IN_CONTAINER  *istr0_buf[2];
<a name="l228"></a>  </span><span class=cB9>CTask</span><span class=cB0> *task;
<a name="l229"></a>  </span><span class=cB9>I64</span><span class=cB0> waveform;
<a name="l230"></a>  </span><span class=cB1>F64</span><span class=cB0> freq,amp;
<a name="l231"></a>  CSndWaveCtrl *tone_swcs[HD_TONES];
<a name="l232"></a>  </span><span class=cB1>U8</span><span class=cB0> rirb_rp,corb_wp;
<a name="l233"></a>  </span><span class=cB1>Bool</span><span class=cB0> audio_task_started,in_running,out_running;
<a name="l234"></a>} hda;
<a name="l235"></a></span><span class=cB5>MemSet</span><span class=cB0>(&amp;hda,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>CHDAudioCtrl</span><span class=cB7>)</span><span class=cB0>);
<a name="l236"></a>
<a name="l237"></a></span><span class=cB1>U0</span><span class=cB0> HDSyncCORB()
<a name="l238"></a>{
<a name="l239"></a>  </span><span class=cB9>U16</span><span class=cB0> *wp,*rp;
<a name="l240"></a>  wp =hda.bar+HD_CORBWP;
<a name="l241"></a>  *wp=hda.corb_wp;
<a name="l242"></a>  rp =hda.bar+HD_CORBRP;
<a name="l243"></a>  </span><span class=cB1>while</span><span class=cB0> (*rp&amp;255!=hda.corb_wp)
<a name="l244"></a>    </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l245"></a>}
<a name="l246"></a>
<a name="l247"></a></span><span class=cB1>U0</span><span class=cB0> HDWriteCORB(</span><span class=cB9>I64</span><span class=cB0> cad,</span><span class=cB9>I64</span><span class=cB0> nid,</span><span class=cB9>U32</span><span class=cB0> val)
<a name="l248"></a>{
<a name="l249"></a>  val|=cad&lt;&lt;28+nid&lt;&lt;20;
<a name="l250"></a>  hda.corb[++hda.corb_wp]=val;
<a name="l251"></a>}
<a name="l252"></a>
<a name="l253"></a></span><span class=cB9>I64</span><span class=cB0> HDSyncRIRB()
<a name="l254"></a>{
<a name="l255"></a>  </span><span class=cB9>U16</span><span class=cB0> *_w;
<a name="l256"></a>  </span><span class=cB9>I64</span><span class=cB0> wp,res=0;
<a name="l257"></a>  _w=hda.bar+HD_RIRBWP;
<a name="l258"></a>  wp=*_w;
<a name="l259"></a>  </span><span class=cB1>while</span><span class=cB0> (hda.rirb_rp!=wp)
<a name="l260"></a>    res=hda.rirb[++hda.rirb_rp];
<a name="l261"></a>  </span><span class=cB1>return</span><span class=cB0> res;
<a name="l262"></a>}
<a name="l263"></a>
<a name="l264"></a></span><span class=cB9>I64</span><span class=cB0> HDReadRIRB()
<a name="l265"></a>{
<a name="l266"></a>  </span><span class=cB9>U16</span><span class=cB0> *_w;
<a name="l267"></a>  </span><span class=cB9>I64</span><span class=cB0> wp,res=0;
<a name="l268"></a>  _w=hda.bar+HD_RIRBWP;
<a name="l269"></a>  </span><span class=cB1>do</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l270"></a>    </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l271"></a>    wp=*_w;
<a name="l272"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>while</span><span class=cB0> (wp==hda.rirb_rp);
<a name="l273"></a>  res=hda.rirb[++hda.rirb_rp];
<a name="l274"></a>  </span><span class=cB1>return</span><span class=cB0> res;
<a name="l275"></a>}
<a name="l276"></a>
<a name="l277"></a></span><span class=cB9>I64</span><span class=cB0> HDWriteCORBSync(</span><span class=cB9>I64</span><span class=cB0> cad,</span><span class=cB9>I64</span><span class=cB0> nid,</span><span class=cB9>U32</span><span class=cB0> val)
<a name="l278"></a>{
<a name="l279"></a>  HDSyncCORB;
<a name="l280"></a>  HDSyncRIRB;
<a name="l281"></a>  HDWriteCORB(cad,nid,val);
<a name="l282"></a>  HDSyncCORB;
<a name="l283"></a>  </span><span class=cB1>return</span><span class=cB0> HDReadRIRB;
<a name="l284"></a>}
<a name="l285"></a>
<a name="l286"></a></span><span class=cB1>Bool</span><span class=cB0> HDTestCORBSync(</span><span class=cB9>I64</span><span class=cB0> cad,</span><span class=cB9>I64</span><span class=cB0> nid,</span><span class=cB9>U32</span><span class=cB0> val)
<a name="l287"></a>{ </span><span class=cB2>//Checks for a response</span><span class=cB0>
<a name="l288"></a>  </span><span class=cB9>U16</span><span class=cB0> *_w;
<a name="l289"></a>  </span><span class=cB9>I64</span><span class=cB0> wp;
<a name="l290"></a>
<a name="l291"></a>  HDSyncCORB;
<a name="l292"></a>  HDSyncRIRB;
<a name="l293"></a>  HDWriteCORB(cad,nid,val);
<a name="l294"></a>  HDSyncCORB;
<a name="l295"></a>
<a name="l296"></a>  </span><span class=cB5>Sleep</span><span class=cB0>(1);
<a name="l297"></a>  _w=hda.bar+HD_RIRBWP;
<a name="l298"></a>  wp=*_w;
<a name="l299"></a>  </span><span class=cB1>if</span><span class=cB0> (wp==hda.rirb_rp)
<a name="l300"></a>    </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l301"></a>  HDReadRIRB;
<a name="l302"></a>  </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>TRUE</span><span class=cB0>;
<a name="l303"></a>}
<a name="l304"></a>
<a name="l305"></a></span><span class=cB1>U0</span><span class=cB0> HDTraverse(</span><span class=cB9>I64</span><span class=cB0> cad,</span><span class=cB9>I64</span><span class=cB0> nid)
<a name="l306"></a>{
<a name="l307"></a>  </span><span class=cB9>I64</span><span class=cB0> i,len,aud_cap,type;
<a name="l308"></a>  HDWriteCORBSync(cad,nid,VERB_POWER_STATE_SET+0x00); </span><span class=cB2>//0 is on</span><span class=cB0>
<a name="l309"></a>  HDWriteCORBSync(cad,nid,VERB_EAPDBTL_ENABLE_SET+0x02);
<a name="l310"></a>  HDWriteCORBSync(cad,nid,VERB_PROCESS_STATE_SET+0x02);
<a name="l311"></a>  HDWriteCORBSync(cad,nid,VERB_CONNECT_SEL_SET+0x00);
<a name="l312"></a>  aud_cap=HDWriteCORBSync(cad,nid,VERB_GET_PARAM+P_SUBNODE_CNT);
<a name="l313"></a>  </span><span class=cB1>if</span><span class=cB0> (aud_cap.u16[0]) </span><span class=cB7>{</span><span class=cB0>
<a name="l314"></a>    </span><span class=cB1>for</span><span class=cB0> (i=aud_cap.u16[1];i&lt;aud_cap.u16[1]+aud_cap.u16[0];i++)
<a name="l315"></a>      HDTraverse(cad,i);
<a name="l316"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>else</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l317"></a>    aud_cap=HDWriteCORBSync(cad,nid,VERB_GET_PARAM+P_AUDIO_WIDGET_CAP);
<a name="l318"></a>    type=aud_cap&gt;&gt;20&amp;15;
<a name="l319"></a>    </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB5>Bt</span><span class=cB7>(</span><span class=cB0>&amp;aud_cap,8</span><span class=cB7>)</span><span class=cB0>)
<a name="l320"></a>      len=HDWriteCORBSync(cad,nid,VERB_GET_PARAM+P_CONNECT_LST_LEN)&amp;127;
<a name="l321"></a>    </span><span class=cB1>else</span><span class=cB0>
<a name="l322"></a>      len=0;
<a name="l323"></a>    HDWriteCORBSync(cad,nid,VERB_AMPLIFIER_GAIN_SET+0xF07F); </span><span class=cB2>//set I/O amp #0</span><span class=cB0>
<a name="l324"></a>    </span><span class=cB1>for</span><span class=cB0> (i=1;i&lt;len;i++)
<a name="l325"></a></span><span class=cB2>//Set IN amps to mute</span><span class=cB0>
<a name="l326"></a>      HDWriteCORBSync(cad,nid,VERB_AMPLIFIER_GAIN_SET+0x7080+i&lt;&lt;8);
<a name="l327"></a>    </span><span class=cB1>switch</span><span class=cB0> (type) {
<a name="l328"></a>      </span><span class=cB1>case</span><span class=cB0> AWT_OUTPUT:
<a name="l329"></a>        </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB3>FALSE</span><span class=cB0>) </span><span class=cB2>//if disabled</span><span class=cB0>
<a name="l330"></a>          HDWriteCORBSync(cad,nid,VERB_CHAN_STREAM_ID_SET+0x00);
<a name="l331"></a>        </span><span class=cB1>else</span><span class=cB0>
<a name="l332"></a>          HDWriteCORBSync(cad,nid,VERB_CHAN_STREAM_ID_SET+0x10);
<a name="l333"></a>        HDWriteCORBSync(cad,nid,VERB_STREAM_FMT_SET+HD_DFT_OUT_FMT);
<a name="l334"></a>        HDWriteCORBSync(cad,nid,VERB_PROCESS_STATE_SET+0x01);
<a name="l335"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l336"></a>      </span><span class=cB1>case</span><span class=cB0> AWT_INPUT:
<a name="l337"></a>        </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB3>TRUE</span><span class=cB0>) </span><span class=cB2>//if disabled</span><span class=cB0>
<a name="l338"></a>          HDWriteCORBSync(cad,nid,VERB_CHAN_STREAM_ID_SET+0x00);
<a name="l339"></a>        </span><span class=cB1>else</span><span class=cB0>
<a name="l340"></a>          HDWriteCORBSync(cad,nid,VERB_CHAN_STREAM_ID_SET+0x20);
<a name="l341"></a>        HDWriteCORBSync(cad,nid,VERB_STREAM_FMT_SET+HD_DFT_IN_FMT);
<a name="l342"></a>        HDWriteCORBSync(cad,nid,VERB_PROCESS_STATE_SET+0x01);
<a name="l343"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l344"></a>      </span><span class=cB1>case</span><span class=cB0> AWT_PIN_COMPLEX:
<a name="l345"></a>        HDWriteCORBSync(cad,nid,VERB_PIN_WIDGET_CTL_SET+0xE2);
<a name="l346"></a>        </span><span class=cB1>break</span><span class=cB0>;
<a name="l347"></a>    }
<a name="l348"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l349"></a>}
<a name="l350"></a>
<a name="l351"></a></span><span class=cB1>U0</span><span class=cB0> HDRun(</span><span class=cB1>Bool</span><span class=cB0> in,</span><span class=cB1>Bool</span><span class=cB0> out)
<a name="l352"></a>{
<a name="l353"></a>  </span><span class=cB9>U32</span><span class=cB0> *_d;
<a name="l354"></a>  </span><span class=cB1>if</span><span class=cB0> (hda.bar) </span><span class=cB7>{</span><span class=cB0>
<a name="l355"></a>    </span><span class=cB1>if</span><span class=cB0> (out) {
<a name="l356"></a>      _d=hda.bar+OSTR0+STRCTL;
<a name="l357"></a>      *_d=0x100002;
<a name="l358"></a>      hda.out_running=</span><span class=cB3>TRUE</span><span class=cB0>;
<a name="l359"></a>    }
<a name="l360"></a>    </span><span class=cB1>if</span><span class=cB0> (in) {
<a name="l361"></a>      _d=hda.bar+ISTR0+STRCTL;
<a name="l362"></a>      *_d=0x200002;
<a name="l363"></a>      hda.in_running=</span><span class=cB3>TRUE</span><span class=cB0>;
<a name="l364"></a>    }
<a name="l365"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l366"></a>}
<a name="l367"></a>
<a name="l368"></a></span><span class=cB1>U0</span><span class=cB0> HDStop(</span><span class=cB1>Bool</span><span class=cB0> in,</span><span class=cB1>Bool</span><span class=cB0> out)
<a name="l369"></a>{
<a name="l370"></a>  </span><span class=cB9>U32</span><span class=cB0> *_d;
<a name="l371"></a>  </span><span class=cB1>if</span><span class=cB0> (hda.bar) </span><span class=cB7>{</span><span class=cB0>
<a name="l372"></a>    </span><span class=cB1>if</span><span class=cB0> (out) {
<a name="l373"></a>      _d=hda.bar+OSTR0+STRCTL;
<a name="l374"></a>      *_d=0;
<a name="l375"></a>      hda.out_running=</span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l376"></a>    }
<a name="l377"></a>    </span><span class=cB1>if</span><span class=cB0> (in) {
<a name="l378"></a>      _d=hda.bar+ISTR0+STRCTL;
<a name="l379"></a>      *_d=0;
<a name="l380"></a>      hda.in_running=</span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l381"></a>    }
<a name="l382"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l383"></a>}
<a name="l384"></a>
<a name="l385"></a></span><span class=cB1>U0</span><span class=cB0> HDSnd(</span><span class=cB1>F64</span><span class=cB0> freq,</span><span class=cB9>I64</span><span class=cB0> waveform=WF_SQUARE,</span><span class=cB1>F64</span><span class=cB0> amp=1.0)
<a name="l386"></a>{
<a name="l387"></a>  hda.waveform=waveform;
<a name="l388"></a>  hda.amp=amp;
<a name="l389"></a>  hda.freq=freq;
<a name="l390"></a>}
<a name="l391"></a>
<a name="l392"></a></span><span class=cB1>U0</span><span class=cB0> HDFillBuf(SND_OUT_CONTAINER *buf,</span><span class=cB9>I64</span><span class=cB0>)
<a name="l393"></a>{
<a name="l394"></a>  </span><span class=cB9>I64</span><span class=cB0> i,size=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER);
<a name="l395"></a>  </span><span class=cB1>if</span><span class=cB0> (!hda.o_tmp_buf)
<a name="l396"></a>    hda.o_tmp_buf=</span><span class=cB5>AMAlloc</span><span class=cB0>(size);
<a name="l397"></a>  </span><span class=cB5>MemSet</span><span class=cB0>(hda.o_tmp_buf,0,size);
<a name="l398"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;HD_TONES;i++)
<a name="l399"></a>    SndWaveAddBuf(hda.tone_swcs[i],hda.o_tmp_buf,
<a name="l400"></a>          SND_BUF_LEN/SND_OCHANNELS,hda.freq,
<a name="l401"></a>          hda.waveform,snd_vol*hda.amp);
<a name="l402"></a>  </span><span class=cB5>MemCpy</span><span class=cB0>(buf,hda.o_tmp_buf,size);
<a name="l403"></a>}
<a name="l404"></a>
<a name="l405"></a></span><span class=cB1>U0</span><span class=cB0> HDAudioTaskEndCB()
<a name="l406"></a>{
<a name="l407"></a>  </span><span class=cB9>I64</span><span class=cB0> i;
<a name="l408"></a>  HDStop(</span><span class=cB3>FALSE</span><span class=cB0>,</span><span class=cB3>TRUE</span><span class=cB0>);
<a name="l409"></a>  fp_snd=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l410"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;HD_TONES;i++) </span><span class=cB7>{</span><span class=cB0>
<a name="l411"></a>    SndWaveCtrlDel(hda.tone_swcs[i]);
<a name="l412"></a>    hda.tone_swcs[i]=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l413"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l414"></a>  </span><span class=cB5>Exit</span><span class=cB0>;
<a name="l415"></a>}
<a name="l416"></a>
<a name="l417"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> HDTonesInit()
<a name="l418"></a>{
<a name="l419"></a>  </span><span class=cB9>I64</span><span class=cB0> i;
<a name="l420"></a>  </span><span class=cB1>if</span><span class=cB0> (hda.bar) </span><span class=cB7>{</span><span class=cB0>
<a name="l421"></a>    </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;HD_TONES;i++) {
<a name="l422"></a>      hda.tone_swcs[i]-&gt;freq_multiplier=1.0;
<a name="l423"></a>      hda.tone_swcs[i]-&gt;amp_multiplier=0;
<a name="l424"></a>    }
<a name="l425"></a>    hda.tone_swcs[0]-&gt;amp_multiplier=1.0;
<a name="l426"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l427"></a>}
<a name="l428"></a>
<a name="l429"></a></span><span class=cB1>U0</span><span class=cB0> HDAudioTask(</span><span class=cB9>I64</span><span class=cB0>)
<a name="l430"></a>{
<a name="l431"></a></span><span class=cB2>//I didn't feel like messing around with PCI interrupts</span><span class=cB0>
<a name="l432"></a>  </span><span class=cB2>//so this task polls every millisecond to know when to</span><span class=cB0>
<a name="l433"></a>  </span><span class=cB2>//switch buffers.</span><span class=cB0>
<a name="l434"></a>  </span><span class=cB9>I64</span><span class=cB0> i,next_obuf_trigger=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER)/2,
<a name="l435"></a>        obuf_rollover=0,
<a name="l436"></a>        next_ibuf_trigger=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_IN_CONTAINER),
<a name="l437"></a>        ibuf_rollover=0;
<a name="l438"></a>  </span><span class=cB9>U32</span><span class=cB0> *pos_in_obuf=hda.bar+OSTR0+STRLPIB,
<a name="l439"></a>        *pos_in_ibuf=hda.bar+ISTR0+STRLPIB;
<a name="l440"></a>  </span><span class=cB5>Fs</span><span class=cB0>-&gt;task_end_cb=&amp;HDAudioTaskEndCB;
<a name="l441"></a>  </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;HD_TONES;i++)
<a name="l442"></a>    hda.tone_swcs[i]=SndWaveCtrlNew;
<a name="l443"></a>  HDTonesInit;
<a name="l444"></a>  hda.freq=0;
<a name="l445"></a>  </span><span class=cB5>Snd</span><span class=cB0>;
<a name="l446"></a>  fp_snd=&amp;HDSnd;
<a name="l447"></a>  fp_snd_fill_buf=&amp;HDFillBuf;
<a name="l448"></a>  fp_snd_copy_buf=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l449"></a>  snd_obuf_num=1;
<a name="l450"></a>  snd_ibuf_num=1;
<a name="l451"></a>  HDRun(</span><span class=cB3>FALSE</span><span class=cB0>,</span><span class=cB3>TRUE</span><span class=cB0>);
<a name="l452"></a>  hda.audio_task_started=</span><span class=cB3>TRUE</span><span class=cB0>; </span><span class=cB2>//This flag is probably not necessary</span><span class=cB0>
<a name="l453"></a>  </span><span class=cB1>while</span><span class=cB0> (</span><span class=cB3>TRUE</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l454"></a>    </span><span class=cB1>if</span><span class=cB0> (next_obuf_trigger-obuf_rollover&lt;=*pos_in_obuf&lt;
<a name="l455"></a>          next_obuf_trigger-obuf_rollover+
<a name="l456"></a>          </span><span class=cB7>(</span><span class=cB0>HD_POS_BUF_MULTIPLES-1</span><span class=cB7>)</span><span class=cB0>*SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_OUT_CONTAINER</span><span class=cB7>)</span><span class=cB0>) {
<a name="l457"></a>      next_obuf_trigger+=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER);
<a name="l458"></a>      </span><span class=cB1>if</span><span class=cB0> (next_obuf_trigger-obuf_rollover&gt;=
<a name="l459"></a>            HD_POS_BUF_MULTIPLES*SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_OUT_CONTAINER</span><span class=cB7>)</span><span class=cB0>)
<a name="l460"></a>        obuf_rollover+=HD_POS_BUF_MULTIPLES*SND_BUF_LEN
<a name="l461"></a>              *</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER);
<a name="l462"></a>      </span><span class=cB1>if</span><span class=cB0> (fp_snd_fill_buf) </span><span class=cB7>{</span><span class=cB0>
<a name="l463"></a>        </span><span class=cB5>LBts</span><span class=cB0>(&amp;snd_flags,Sf_FILLING_OUT);
<a name="l464"></a>        (*fp_snd_fill_buf)(hda.ostr0_buf[snd_obuf_num&amp;1],snd_obuf_num);
<a name="l465"></a>        </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB5>IsMute</span><span class=cB0>)
<a name="l466"></a>          </span><span class=cB5>MemSet</span><span class=cB0>(hda.ostr0_buf[snd_obuf_num&amp;1],0,
<a name="l467"></a>                SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_OUT_CONTAINER</span><span class=cB7>)</span><span class=cB0>);
<a name="l468"></a>        </span><span class=cB5>LBtr</span><span class=cB0>(&amp;snd_flags,Sf_FILLING_OUT);
<a name="l469"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l470"></a>      snd_obuf_num++;
<a name="l471"></a>    }
<a name="l472"></a>    </span><span class=cB1>if</span><span class=cB0> (next_ibuf_trigger-ibuf_rollover&lt;=*pos_in_ibuf&lt;
<a name="l473"></a>          next_ibuf_trigger-ibuf_rollover+</span><span class=cB7>(</span><span class=cB0>HD_POS_BUF_MULTIPLES-1</span><span class=cB7>)</span><span class=cB0>
<a name="l474"></a>          *SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_IN_CONTAINER</span><span class=cB7>)</span><span class=cB0>) {
<a name="l475"></a>      next_ibuf_trigger+=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_IN_CONTAINER);
<a name="l476"></a>      </span><span class=cB1>if</span><span class=cB0> (next_ibuf_trigger-ibuf_rollover&gt;=
<a name="l477"></a>            HD_POS_BUF_MULTIPLES*SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_IN_CONTAINER</span><span class=cB7>)</span><span class=cB0>)
<a name="l478"></a>        ibuf_rollover+=HD_POS_BUF_MULTIPLES*SND_BUF_LEN
<a name="l479"></a>              *</span><span class=cB1>sizeof</span><span class=cB0>(SND_IN_CONTAINER);
<a name="l480"></a>      </span><span class=cB1>if</span><span class=cB0> (fp_snd_copy_buf)
<a name="l481"></a>        (*fp_snd_copy_buf)(hda.istr0_buf[snd_obuf_num&amp;1],snd_ibuf_num);
<a name="l482"></a>      snd_ibuf_num++;
<a name="l483"></a>    }
<a name="l484"></a>    </span><span class=cB5>Sleep</span><span class=cB0>(1);
<a name="l485"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l486"></a>}
<a name="l487"></a>
<a name="l488"></a></span><span class=cB1>U0</span><span class=cB0> HDRst()
<a name="l489"></a>{
<a name="l490"></a>  </span><span class=cB9>U32</span><span class=cB0> d,*_d;
<a name="l491"></a>  HDStop(</span><span class=cB3>TRUE</span><span class=cB0>,</span><span class=cB3>TRUE</span><span class=cB0>);
<a name="l492"></a>  _d=hda.bar+HD_GCTL;
<a name="l493"></a>  *_d=0;  </span><span class=cB2>//rst</span><span class=cB0>
<a name="l494"></a>  </span><span class=cB1>do</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l495"></a>    </span><span class=cB5>Sleep</span><span class=cB0>(1);
<a name="l496"></a>    d=*_d;
<a name="l497"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>while</span><span class=cB0> (d &amp; 1);
<a name="l498"></a>  *_d=1;
<a name="l499"></a>  </span><span class=cB1>do</span><span class=cB0> </span><span class=cB7>{</span><span class=cB0>
<a name="l500"></a>    </span><span class=cB5>Sleep</span><span class=cB0>(1);
<a name="l501"></a>    d=*_d;
<a name="l502"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>while</span><span class=cB0> (!</span><span class=cB7>(</span><span class=cB0>d &amp; 1</span><span class=cB7>)</span><span class=cB0>);
<a name="l503"></a>  </span><span class=cB5>Sleep</span><span class=cB0>(1);
<a name="l504"></a>}
<a name="l505"></a>
<a name="l506"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> HDAudioEnd(</span><span class=cB1>Bool</span><span class=cB0> rst=</span><span class=cB3>TRUE</span><span class=cB0>)
<a name="l507"></a>{
<a name="l508"></a>  snd_dev=SD_PC_SPEAKER;
<a name="l509"></a>  </span><span class=cB1>if</span><span class=cB0> (hda.bar) </span><span class=cB7>{</span><span class=cB0>
<a name="l510"></a>    </span><span class=cB5>Kill</span><span class=cB0>(hda.task);
<a name="l511"></a>    hda.task=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l512"></a>    </span><span class=cB1>if</span><span class=cB0> (rst)
<a name="l513"></a>      HDRst;
<a name="l514"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.corb);
<a name="l515"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.rirb);
<a name="l516"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.o_tmp_buf);
<a name="l517"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.ostr0_buf[0]);
<a name="l518"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.ostr0_buf[1]);
<a name="l519"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.istr0_buf[0]);
<a name="l520"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.istr0_buf[1]);
<a name="l521"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.ostr0_bdl);
<a name="l522"></a>    </span><span class=cB5>Free</span><span class=cB0>(hda.istr0_bdl);
<a name="l523"></a>    </span><span class=cB5>Mem32DevFree</span><span class=cB0>(hda.bar);
<a name="l524"></a>    hda.bar=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l525"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l526"></a>}
<a name="l527"></a>
<a name="l528"></a></span><span class=cB1>U0</span><span class=cB0> HDAudioUncachedInit()
<a name="l529"></a>{
<a name="l530"></a>  </span><span class=cB9>I64</span><span class=cB0> shared_blks=1;
<a name="l531"></a>  hda.bp=Mem2MegUncachedAlloc(&amp;shared_blks);
<a name="l532"></a>  hda.hc=HeapCtrlBPInit(hda.bp,shared_blks&lt;&lt;12);
<a name="l533"></a>}
<a name="l534"></a>
<a name="l535"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>Bool</span><span class=cB0> HDAudioInit(</span><span class=cB9>I64</span><span class=cB0> hd_bus,</span><span class=cB9>I64</span><span class=cB0> hd_dev,</span><span class=cB9>I64</span><span class=cB0> hd_fun)
<a name="l536"></a>{
<a name="l537"></a>  </span><span class=cB9>I64</span><span class=cB0> i;
<a name="l538"></a>  </span><span class=cB9>U32</span><span class=cB0> *_d;
<a name="l539"></a>  </span><span class=cB9>U16</span><span class=cB0> w,*_w;
<a name="l540"></a>  </span><span class=cB1>U8</span><span class=cB0> *_b;
<a name="l541"></a>  </span><span class=cB1>if</span><span class=cB0> (hda.bar)
<a name="l542"></a>    HDAudioEnd;
<a name="l543"></a>  </span><span class=cB1>else</span><span class=cB0>
<a name="l544"></a>    HDAudioUncachedInit;
<a name="l545"></a>  </span><span class=cB1>if</span><span class=cB0> (</span><span class=cB5>PCIReadU16</span><span class=cB7>(</span><span class=cB0>hd_bus,hd_dev,hd_fun,0</span><span class=cB7>)</span><span class=cB0>==0x8086 &amp;&amp;
<a name="l546"></a>        </span><span class=cB7>(</span><span class=cB0>hda.bar=</span><span class=cB5>Mem32DevAlloc</span><span class=cB0>(0x4000,0x4000)</span><span class=cB7>)</span><span class=cB0> ) </span><span class=cB7>{</span><span class=cB0>
<a name="l547"></a>    </span><span class=cB5>PCIWriteU32</span><span class=cB0>(hd_bus,hd_dev,hd_fun,0x14,hda.bar</span><span class=cB7>(</span><span class=cB9>I64</span><span class=cB7>)</span><span class=cB0>.u32[1]);
<a name="l548"></a>    </span><span class=cB5>PCIWriteU32</span><span class=cB0>(hd_bus,hd_dev,hd_fun,0x10,hda.bar</span><span class=cB7>(</span><span class=cB9>I64</span><span class=cB7>)</span><span class=cB0>.u32[0]);
<a name="l549"></a>    </span><span class=cB5>PCIWriteU16</span><span class=cB0>(hd_bus,hd_dev,hd_fun,0x04,
<a name="l550"></a>          </span><span class=cB5>PCIReadU16</span><span class=cB7>(</span><span class=cB0>hd_bus,hd_dev,hd_fun,0x04</span><span class=cB7>)</span><span class=cB0>|0x406);
<a name="l551"></a>
<a name="l552"></a>    HDRst;
<a name="l553"></a>
<a name="l554"></a>    hda.corb=</span><span class=cB5>CAllocAligned</span><span class=cB0>(HD_CORB_ENTRIES*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB9>U32</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l555"></a>    _d=hda.bar+HD_CORBLBASE;
<a name="l556"></a>    *_d=hda.corb(</span><span class=cB9>I64</span><span class=cB0>).u32[0];
<a name="l557"></a>    _d=hda.bar+HD_CORBUBASE;
<a name="l558"></a>    *_d=hda.corb(</span><span class=cB9>I64</span><span class=cB0>).u32[1];
<a name="l559"></a>
<a name="l560"></a>    hda.rirb=</span><span class=cB5>CAllocAligned</span><span class=cB0>(HD_RIRB_ENTRIES*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB9>I64</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l561"></a>    _d=hda.bar+HD_RIRBLBASE;
<a name="l562"></a>    *_d=hda.rirb(</span><span class=cB9>I64</span><span class=cB0>).u32[0];
<a name="l563"></a>    _d=hda.bar+HD_RIRBUBASE;
<a name="l564"></a>    *_d=hda.rirb(</span><span class=cB9>I64</span><span class=cB0>).u32[1];
<a name="l565"></a>
<a name="l566"></a>    _w=hda.bar+HD_CORBRP;
<a name="l567"></a>    *_w=0x8000; </span><span class=cB2>//Rst read ptr</span><span class=cB0>
<a name="l568"></a>    </span><span class=cB1>do</span><span class=cB0> {
<a name="l569"></a>      </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l570"></a>      w=*_w;
<a name="l571"></a>    } </span><span class=cB1>while</span><span class=cB0> (!</span><span class=cB7>(</span><span class=cB0>w&amp;0x8000</span><span class=cB7>)</span><span class=cB0>);
<a name="l572"></a>    *_w=0x0000; </span><span class=cB2>//Rst read ptr</span><span class=cB0>
<a name="l573"></a>    </span><span class=cB1>do</span><span class=cB0> {
<a name="l574"></a>      </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l575"></a>      w=*_w;
<a name="l576"></a>    } </span><span class=cB1>while</span><span class=cB0> (w&amp;0x8000);
<a name="l577"></a>
<a name="l578"></a>    _w=hda.bar+HD_RIRBWP;
<a name="l579"></a>    *_w=0x8000; </span><span class=cB2>//Rst write ptr</span><span class=cB0>
<a name="l580"></a>
<a name="l581"></a>    _b=hda.bar+HD_CORBCTL;
<a name="l582"></a>    *_b=0x02; </span><span class=cB2>//Run</span><span class=cB0>
<a name="l583"></a>    _b=hda.bar+HD_RIRBCTL;
<a name="l584"></a>    *_b=0x02; </span><span class=cB2>//Run</span><span class=cB0>
<a name="l585"></a>
<a name="l586"></a>    _w=hda.bar+HD_CORBWP;
<a name="l587"></a>    hda.corb_wp=*_w;
<a name="l588"></a>    _w=hda.bar+HD_RIRBWP;
<a name="l589"></a>    hda.rirb_rp=*_w;
<a name="l590"></a>
<a name="l591"></a>    hda.ostr0_bdl =</span><span class=cB5>CAllocAligned</span><span class=cB0>(
<a name="l592"></a>          HD_BDL_ENTRIES*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>CHDBufDesc</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l593"></a>    _d=hda.bar+OSTR0+STRBDPL;
<a name="l594"></a>    *_d=hda.ostr0_bdl(</span><span class=cB9>I64</span><span class=cB0>).u32[0];
<a name="l595"></a>    _d=hda.bar+OSTR0+STRBDPU;
<a name="l596"></a>    *_d=hda.ostr0_bdl(</span><span class=cB9>I64</span><span class=cB0>).u32[1];
<a name="l597"></a>    </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;2;i++) {
<a name="l598"></a>      hda.ostr0_bdl[i].buf=hda.ostr0_buf[i]=
<a name="l599"></a>            </span><span class=cB5>CAllocAligned</span><span class=cB0>(
<a name="l600"></a>            SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_OUT_CONTAINER</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l601"></a>      hda.ostr0_bdl[i].len=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER);
<a name="l602"></a>      hda.ostr0_bdl[i].ctrl=1;
<a name="l603"></a>    }
<a name="l604"></a>
<a name="l605"></a>    hda.istr0_bdl =</span><span class=cB5>CAllocAligned</span><span class=cB0>(
<a name="l606"></a>          HD_BDL_ENTRIES*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>CHDBufDesc</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l607"></a>    _d=hda.bar+ISTR0+STRBDPL;
<a name="l608"></a>    *_d=hda.istr0_bdl(</span><span class=cB9>I64</span><span class=cB0>).u32[0];
<a name="l609"></a>    _d=hda.bar+ISTR0+STRBDPU;
<a name="l610"></a>    *_d=hda.istr0_bdl(</span><span class=cB9>I64</span><span class=cB0>).u32[1];
<a name="l611"></a>    </span><span class=cB1>for</span><span class=cB0> (i=0;i&lt;2;i++) {
<a name="l612"></a>      hda.istr0_bdl[i].buf=hda.istr0_buf[i]=</span><span class=cB5>CAllocAligned</span><span class=cB0>(
<a name="l613"></a>            SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>SND_IN_CONTAINER</span><span class=cB7>)</span><span class=cB0>,128,hda.hc);
<a name="l614"></a>      hda.istr0_bdl[i].len=SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_IN_CONTAINER);
<a name="l615"></a>      hda.istr0_bdl[i].ctrl=1;
<a name="l616"></a>    }
<a name="l617"></a>
<a name="l618"></a>    _w=hda.bar+HD_STATESTS;
<a name="l619"></a>    w=*_w;
<a name="l620"></a>    </span><span class=cB1>while</span><span class=cB0> (w) {
<a name="l621"></a>      hda.cad=</span><span class=cB5>Bsf</span><span class=cB0>(w);
<a name="l622"></a>      </span><span class=cB1>if</span><span class=cB0> (HDTestCORBSync</span><span class=cB7>(</span><span class=cB0>hda.cad,0,VERB_GET_PARAM+P_SUBNODE_CNT</span><span class=cB7>)</span><span class=cB0>) </span><span class=cB7>{</span><span class=cB0>
<a name="l623"></a>        HDTraverse(hda.cad,0);
<a name="l624"></a>
<a name="l625"></a>        _d=hda.bar+OSTR0+STRLPIB;
<a name="l626"></a>        *_d=0;
<a name="l627"></a>        _d=hda.bar+OSTR0+STRCBL;
<a name="l628"></a>        *_d=HD_POS_BUF_MULTIPLES*SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_OUT_CONTAINER);
<a name="l629"></a>        _w=hda.bar+OSTR0+STRLVI;
<a name="l630"></a>        *_w=1;  </span><span class=cB2>//last valid idx</span><span class=cB0>
<a name="l631"></a>        _w=hda.bar+OSTR0+STRFMT;
<a name="l632"></a>        *_w=HD_DFT_OUT_FMT;
<a name="l633"></a>
<a name="l634"></a>        _d=hda.bar+ISTR0+STRLPIB;
<a name="l635"></a>        *_d=0;
<a name="l636"></a>        _d=hda.bar+ISTR0+STRCBL;
<a name="l637"></a>        *_d=HD_POS_BUF_MULTIPLES*SND_BUF_LEN*</span><span class=cB1>sizeof</span><span class=cB0>(SND_IN_CONTAINER);
<a name="l638"></a>        _w=hda.bar+ISTR0+STRLVI;
<a name="l639"></a>        *_w=1;  </span><span class=cB2>//last valid idx</span><span class=cB0>
<a name="l640"></a>        _w=hda.bar+ISTR0+STRFMT;
<a name="l641"></a>        *_w=HD_DFT_IN_FMT;
<a name="l642"></a>
<a name="l643"></a>        </span><span class=cB5>LBts</span><span class=cB0>(&amp;</span><span class=cBB>sys_semas</span><span class=cB0>[</span><span class=cB3>SEMA_SND</span><span class=cB0>],0); </span><span class=cB2>//turn off until cfg completed</span><span class=cB0>
<a name="l644"></a>        </span><span class=cB5>LBtr</span><span class=cB0>(&amp;snd_flags,Sf_FILLING_OUT);
<a name="l645"></a>        hda.audio_task_started=</span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l646"></a>        </span><span class=cB1>if</span><span class=cB0> (</span><span class=cBB>mp_cnt</span><span class=cB0>&gt;1)
<a name="l647"></a>          hda.task=</span><span class=cB5>Spawn</span><span class=cB0>(&amp;HDAudioTask,</span><span class=cB3>NULL</span><span class=cB0>,</span><span class=cB6>&quot;HD Audio&quot;</span><span class=cB0>,1);
<a name="l648"></a>        </span><span class=cB1>else</span><span class=cB0>
<a name="l649"></a>          hda.task=</span><span class=cB5>Spawn</span><span class=cB0>(&amp;HDAudioTask,</span><span class=cB3>NULL</span><span class=cB0>,</span><span class=cB6>&quot;HD Audio&quot;</span><span class=cB0>);
<a name="l650"></a>        </span><span class=cB1>while</span><span class=cB0> (!hda.audio_task_started)
<a name="l651"></a>          </span><span class=cB5>Yield</span><span class=cB0>;
<a name="l652"></a>        snd_dev=SD_HD_AUDIO;
<a name="l653"></a>        </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>TRUE</span><span class=cB0>;
<a name="l654"></a>      </span><span class=cB7>}</span><span class=cB0>
<a name="l655"></a>      </span><span class=cB5>Btr</span><span class=cB0>(&amp;w,hda.cad);
<a name="l656"></a>    }
<a name="l657"></a>    HDAudioEnd(</span><span class=cB3>FALSE</span><span class=cB0>);
<a name="l658"></a>  </span><span class=cB7>}</span><span class=cB0> </span><span class=cB1>else</span><span class=cB0>
<a name="l659"></a>    hda.bar=</span><span class=cB3>NULL</span><span class=cB0>;
<a name="l660"></a>  </span><span class=cB1>return</span><span class=cB0> </span><span class=cB3>FALSE</span><span class=cB0>;
<a name="l661"></a>}
<a name="l662"></a>
<a name="l663"></a>#</span><span class=cB1>help_index</span><span class=cB0> </span><span class=cB6>&quot;&quot;</span><span class=cB0>
</span></div></pre></body>
</html>
